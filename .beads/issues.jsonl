{"id":"main-34g","title":"Implement SQLite backend core with crumbs table accessor","description":"## Required Reading\n- docs/ARCHITECTURE.md (Decision 6: JSONL+SQLite, Decision 9: ORM-style Table)\n- docs/specs/product-requirements/prd001-cupboard-core.yaml (R1-R3, R7-R8: Config, Cupboard, Table interfaces, errors, UUID v7)\n- docs/specs/product-requirements/prd002-sqlite-backend.yaml (R1: Directory Layout, R3: SQLite Schema, R4: Startup Sequence, R5: Write Operations, R6: Shutdown, R11-R15: Implementation details)\n- docs/specs/product-requirements/prd003-crumbs-interface.yaml (R1: Crumb struct, R2: States)\n- pkg/types/cupboard.go (Cupboard interface)\n- pkg/types/table.go (Table interface)\n- pkg/types/config.go (Config struct)\n- pkg/types/crumb.go (Crumb struct)\n\n## Files to Create/Modify\n- internal/sqlite/backend.go (create) — SQLiteCupboard struct implementing Cupboard interface: Attach (create dirs, create JSONL files, create SQLite schema, load JSONL), Detach (close DB), GetTable (route to table accessors)\n- internal/sqlite/crumbs.go (create) — crumbsTable struct implementing Table interface for crumbs: Get, Set (with UUID v7 generation), Delete, Fetch (with filter support for State)\n- internal/sqlite/schema.go (create) — SQL schema constants and createSchema function (crumbs table + indexes only for this task; other tables added later)\n- internal/sqlite/jsonl.go (create) — JSONL read/write helpers: loadJSONL (file → []T), persistJSONL ([]T → atomic write: temp file, fsync, rename)\n\n## Requirements\n- Implement SQLiteCupboard satisfying the Cupboard interface (prd001-cupboard-core R2)\n- Attach: create DataDir if missing (R1.3), create empty crumbs.jsonl if missing (R1.4), delete cupboard.db if exists, create schema (R3.2 crumbs table only), load crumbs.jsonl into SQLite (R4.1)\n- Detach: close SQLite connection, mark as detached (R6.1, R6.2, R6.3)\n- GetTable: return crumbs table accessor for \"crumbs\", ErrTableNotFound for others (R12.1, R12.2). Other table names will return ErrTableNotFound until implemented in future tasks\n- crumbsTable.Get: query by crumb_id, hydrate to Crumb struct (R14.2)\n- crumbsTable.Set: type-assert to Crumb, generate UUID v7 if empty, INSERT or UPDATE, persist to crumbs.jsonl atomically (R5.1, R5.2, R13.3, R15.6, R15.7)\n- crumbsTable.Delete: delete from SQLite, persist to crumbs.jsonl, ErrNotFound if absent (R13.4)\n- crumbsTable.Fetch: filter by State field, return []any of Crumb structs (R13.5, R13.6)\n- JSONL helpers: atomic write (temp file → fsync → rename) per R5.2\n- Use modernc.org/sqlite (pure Go, no CGO) per ARCHITECTURE technology choices\n- Use github.com/google/uuid for UUID v7 generation per ARCHITECTURE Decision 1\n\n## Design Decisions\n- Only implement the crumbs table in this task. Other tables (trails, properties, metadata, links, stashes) follow the same pattern and will be added incrementally.\n- Use sync.RWMutex for single-writer, multiple-reader concurrency (prd002 R8.1-R8.4)\n- Immediate sync strategy only (default per R16.2); batch and on_close added later\n- Skip graph audit (R10) and built-in property seeding (R9) — those depend on properties and links tables\n- Create all 9 JSONL files on Attach (even though only crumbs.jsonl is used) so the directory layout matches the spec from day one\n\n## Acceptance Criteria\n- [ ] SQLiteCupboard implements types.Cupboard (compile-time assertion)\n- [ ] crumbsTable implements types.Table (compile-time assertion)\n- [ ] Attach creates DataDir and JSONL files when they don't exist\n- [ ] Attach creates SQLite schema and loads crumbs.jsonl\n- [ ] Attach on already-attached cupboard returns ErrAlreadyAttached\n- [ ] Detach closes resources; subsequent GetTable returns ErrCupboardDetached\n- [ ] GetTable(\"crumbs\") returns a working Table; GetTable(\"unknown\") returns ErrTableNotFound\n- [ ] Set with empty ID generates UUID v7 and creates crumb\n- [ ] Set with existing ID updates the crumb\n- [ ] Get retrieves a crumb by ID; returns ErrNotFound if absent\n- [ ] Delete removes a crumb; returns ErrNotFound if absent\n- [ ] Fetch with empty filter returns all crumbs\n- [ ] Fetch with State filter returns matching crumbs\n- [ ] JSONL file is updated atomically after each write operation\n- [ ] go build ./internal/sqlite/... compiles without errors","status":"closed","priority":2,"issue_type":"task","owner":"petar.djukic@gmail.com","created_at":"2026-02-11T17:04:02.029072-05:00","created_by":"petardjukic","updated_at":"2026-02-11T17:08:02.272802-05:00","closed_at":"2026-02-11T17:08:02.272802-05:00","close_reason":"Closed"}
{"id":"main-9hm","title":"Wire Cobra CLI with init and version commands","description":"## Required Reading\n- docs/specs/product-requirements/prd009-cupboard-cli.yaml (R1: Root command structure, R2: init and version commands, R8: Global flags, R9: Exit codes, R10: Output modes)\n- docs/specs/product-requirements/prd010-configuration-directories.yaml (R1: Config directory, R2: Data directory, R9: Config struct)\n- docs/specs/use-cases/rel01.0-uc004-scaffolding-validation.yaml (S1: go build, S2: version command)\n- docs/specs/use-cases/rel01.1-uc001-go-install.yaml (F2: --help, F3: init)\n- docs/engineering/eng03-cupboard-cli.md (CLI user guide)\n- cmd/cupboard/main.go (current stub)\n- pkg/crumbs/version.go (version constant)\n- .claude/rules/go-style.md (Cobra as CLI framework)\n\n## Files to Create/Modify\n- cmd/cupboard/main.go (modify) — Replace stub with Cobra root command setup, execute root\n- internal/cli/root.go (create) — Root cobra.Command with global flags: --config-dir, --data-dir, --json, --help\n- internal/cli/version.go (create) — version subcommand: prints version string from pkg/crumbs/version.go, exits 0\n- internal/cli/init.go (create) — init subcommand: creates config directory (.crumbs/) with config.yaml, creates data directory (.crumbs-db/) by calling Cupboard.Attach then Detach, prints confirmation\n\n## Requirements\n- Use spf13/cobra for CLI framework per go-style.md\n- Root command: \"cupboard\" with short/long description, persistent flags for --config-dir (default .crumbs), --data-dir (default .crumbs-db), --json (bool)\n- version command: print \"cupboard v\u003cversion\u003e\" to stdout, exit 0 (prd009 R2.2)\n- init command: create config dir with config.yaml (backend: sqlite, data_dir: \u003cpath\u003e), call Attach to initialize data directory and JSONL files, then Detach (prd009 R2.1, prd010 R1.6, R2.1)\n- Exit codes: 0 success, 1 user error, 2 system error (prd009 R9)\n- --json flag stored on root for subcommands to read (prd009 R10)\n\n## Design Decisions\n- CLI lives in internal/cli/ (not cmd/) per go-style.md: cmd/ is minimal entry points, internal/ holds implementation\n- Config directory default: $(CWD)/.crumbs per prd010\n- Data directory default: $(CWD)/.crumbs-db per prd010\n- init writes config.yaml using go-yaml/yaml per go-style.md\n\n## Acceptance Criteria\n- [ ] go build ./cmd/cupboard compiles without errors\n- [ ] cupboard --help prints usage with available commands\n- [ ] cupboard version prints version string and exits 0\n- [ ] cupboard init creates .crumbs/config.yaml and .crumbs-db/ with JSONL files\n- [ ] cupboard init in already-initialized directory succeeds (idempotent)\n- [ ] --config-dir and --data-dir flags override defaults\n- [ ] Exit code 1 on user errors, 2 on system errors","status":"in_progress","priority":2,"issue_type":"task","owner":"petar.djukic@gmail.com","created_at":"2026-02-11T17:04:02.301143-05:00","created_by":"petardjukic","updated_at":"2026-02-11T17:11:40.331032-05:00","dependencies":[{"issue_id":"main-9hm","depends_on_id":"main-34g","type":"blocks","created_at":"2026-02-11T17:04:02.511804-05:00","created_by":"petardjukic"}]}
{"id":"main-wvl","title":"Add unit tests for SQLite backend and crumbs table","description":"## Required Reading\n- docs/specs/test-suites/test-rel01.0-uc001-cupboard-lifecycle.yaml (test cases for Attach, Detach, GetTable)\n- docs/specs/test-suites/test-rel01.0-uc002-table-crud.yaml (test cases for Get, Set, Delete, Fetch)\n- docs/specs/test-suites/test-rel01.0-uc003-crumb-lifecycle.yaml (test cases for crumb state transitions)\n- docs/specs/product-requirements/prd002-sqlite-backend.yaml (R4: Startup, R5: Write, R6: Shutdown error scenarios)\n- internal/sqlite/backend.go (implementation from task 0)\n- internal/sqlite/crumbs.go (implementation from task 0)\n- .claude/rules/go-style.md (testing guidelines: table-driven, edge cases, test helpers)\n\n## Files to Create/Modify\n- internal/sqlite/backend_test.go (create) — Tests for Cupboard lifecycle: Attach creates dirs/files, Attach on already-attached returns error, Detach makes operations fail, GetTable routing, double-Detach is idempotent\n- internal/sqlite/crumbs_test.go (create) — Tests for crumbs Table: Set creates with UUID, Set updates, Get by ID, Get not found, Delete by ID, Delete not found, Fetch all, Fetch with State filter, JSONL roundtrip (delete DB, re-attach, data still there)\n\n## Requirements\n- Table-driven tests per go-style.md guidelines\n- Test helper: newTestCupboard(t) that creates a temp dir, Attaches, and registers t.Cleanup to Detach and remove the dir\n- Cover happy paths and error paths from the test suite YAML specs\n- Verify JSONL persistence: after Set, re-Attach from the same DataDir and confirm data survives\n- Verify state transition validation: Set a crumb with invalid state transition should fail\n- Use testify/assert for assertions per go-style.md\n\n## Acceptance Criteria\n- [ ] go test ./internal/sqlite/... passes with all tests green\n- [ ] Tests cover: Attach lifecycle (create, double-attach, detach, post-detach errors)\n- [ ] Tests cover: crumbs CRUD (create, read, update, delete, fetch with filter)\n- [ ] Tests cover: JSONL roundtrip (data survives DB deletion and re-Attach)\n- [ ] Tests cover: error cases (not found, invalid ID, invalid data type)\n- [ ] Test helper provides clean cupboard per test case","status":"closed","priority":2,"issue_type":"task","owner":"petar.djukic@gmail.com","created_at":"2026-02-11T17:04:02.166031-05:00","created_by":"petardjukic","updated_at":"2026-02-11T17:11:39.833368-05:00","closed_at":"2026-02-11T17:11:39.833368-05:00","close_reason":"Closed","dependencies":[{"issue_id":"main-wvl","depends_on_id":"main-34g","type":"blocks","created_at":"2026-02-11T17:04:02.405234-05:00","created_by":"petardjukic"}]}

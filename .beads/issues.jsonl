{"id":"main-a1a","title":"Integration tests for cupboard lifecycle and crumb CRUD","description":"## Required Reading\n- docs/specs/test-suites/test-rel01.0-uc001-cupboard-lifecycle.yaml (cupboard lifecycle test cases)\n- docs/specs/test-suites/test-rel01.0-uc002-table-crud.yaml (table CRUD test cases)\n- docs/specs/test-suites/test-rel01.0-uc003-crumb-lifecycle.yaml (crumb lifecycle test cases)\n- docs/specs/use-cases/rel01.0-uc001-cupboard-lifecycle.yaml (success criteria S1-S9)\n- docs/specs/use-cases/rel01.0-uc002-table-crud.yaml (success criteria)\n- docs/specs/use-cases/rel01.0-uc003-crumb-lifecycle.yaml (success criteria)\n- pkg/types/ (all type definitions)\n- internal/sqlite/ (backend implementation)\n\n## Files to Create/Modify\n- tests/integration/test_rel01_0_uc001_cupboard_lifecycle_test.go (create) — Table-driven tests for cupboard lifecycle per test suite YAML\n- tests/integration/test_rel01_0_uc002_table_crud_test.go (create) — Table-driven tests for CRUD across entity types per test suite YAML\n- tests/integration/test_rel01_0_uc003_crumb_lifecycle_test.go (create) — Table-driven tests for crumb state machine per test suite YAML\n- tests/integration/helpers_test.go (create) — Shared test helpers: setup cupboard with temp directory, teardown, assertion helpers\n\n## Requirements\n- Implement test cases from the three YAML test suites as Go table-driven tests\n- Each YAML test case maps to one row in the Go test table\n- Shared setup: create temp directory, instantiate SQLiteBackend, Attach with test config\n- Shared teardown: Detach, remove temp directory\n- Cupboard lifecycle tests (uc001): config creation, attach success, attach idempotency (ErrAlreadyAttached), GetTable for standard names, GetTable for unknown name (ErrTableNotFound), Fetch on empty table, detach, operations after detach (ErrCupboardDetached)\n- Table CRUD tests (uc002): Set with empty ID generates UUID, Get by ID returns correct entity, Set with existing ID updates, Delete removes entity, Fetch with empty filter returns all, Fetch with filter returns matching, Delete non-existent returns ErrNotFound\n- Crumb lifecycle tests (uc003): create crumb with name, initial state is draft, SetState transitions, Pebble from taken succeeds, Pebble from non-taken fails (ErrInvalidTransition), Dust from any state, state-based filtering\n- Extract reusable test helpers into helpers_test.go\n\n## Design Decisions\n- Tests live in tests/integration/ per project structure convention\n- Use testify/assert and testify/require for assertions per go-style\n- Table-driven pattern: each test function has a tests slice with name, setup, action, assertions\n- Helpers create a fully wired cupboard with temp directory for isolation\n- Each test case runs in its own temp directory (t.TempDir())\n\n## Acceptance Criteria\n- [ ] All test cases from test-rel01.0-uc001-cupboard-lifecycle.yaml are implemented\n- [ ] All test cases from test-rel01.0-uc002-table-crud.yaml are implemented\n- [ ] All test cases from test-rel01.0-uc003-crumb-lifecycle.yaml are implemented\n- [ ] All tests pass: go test ./tests/integration/...\n- [ ] Tests use table-driven pattern with named subtests\n- [ ] Each test is independent (own temp directory, own cupboard instance)\n- [ ] Shared helpers reduce code duplication across test files\n- [ ] Tests validate success criteria S1-S9 from uc001, success criteria from uc002 and uc003","status":"open","priority":2,"issue_type":"task","owner":"petar.djukic@gmail.com","created_at":"2026-02-11T14:34:38.250254-05:00","created_by":"petardjukic","updated_at":"2026-02-11T14:34:38.250254-05:00","dependencies":[{"issue_id":"main-a1a","depends_on_id":"main-rjt","type":"blocks","created_at":"2026-02-11T14:34:38.47319-05:00","created_by":"petardjukic"}]}
{"id":"main-rjt","title":"Implement SQLite backend with JSONL persistence","description":"## Required Reading\n- docs/specs/product-requirements/prd001-cupboard-core.yaml (Cupboard interface, Table interface, lifecycle)\n- docs/specs/product-requirements/prd002-sqlite-backend.yaml (directory layout, JSONL format, SQLite schema, startup, write pattern, sync strategies, cascade operations, hydration/persistence)\n- docs/specs/product-requirements/prd003-crumbs-interface.yaml (Crumb creation with property initialization, filter keys)\n- docs/specs/product-requirements/prd004-properties-interface.yaml (built-in property seeding, backfill)\n- docs/specs/product-requirements/prd010-configuration-directories.yaml (directory layout, JSONL files, startup sequence, config.yaml)\n- docs/ARCHITECTURE.md § System Components, § Technology Choices\n- pkg/types/ (all type definitions from task 0)\n\n## Files to Create/Modify\n- internal/sqlite/backend.go (create) — SQLiteBackend struct implementing Cupboard interface (Attach, Detach, GetTable), attached state tracking, directory creation, JSONL file creation\n- internal/sqlite/table.go (create) — Table struct implementing Table interface (Get, Set, Delete, Fetch) with entity-type dispatch, UUID v7 generation, timestamp management\n- internal/sqlite/schema.go (create) — SQLite schema creation (CREATE TABLE statements, indexes per prd002), database initialization\n- internal/sqlite/jsonl.go (create) — JSONL reader/writer with atomic write pattern (temp file, fsync, rename), entity hydration (JSON to struct) and persistence (struct to JSON)\n- internal/sqlite/seed.go (create) — Built-in property and category seeding on first startup per prd004 R9, built-in metadata schema registration per prd005 R3\n\n## Requirements\n- Implement SQLiteBackend that satisfies the Cupboard interface from pkg/types\n- Attach must: validate config, create DataDir if needed, create/open JSONL files, open SQLite database, create schema, load JSONL into SQLite, seed built-in properties and schemas, validate graph integrity\n- Detach must: flush pending writes, close database, release resources, be idempotent\n- GetTable must return a Table for each of the 6 standard table names, or ErrTableNotFound\n- Table.Get must retrieve entity by ID, hydrate to correct struct type, return ErrNotFound/ErrInvalidID\n- Table.Set must: generate UUID v7 for empty IDs, set timestamps, validate entity (name, state, type), persist to SQLite and JSONL atomically, handle create vs update\n- Table.Delete must: remove entity and cascade (metadata, links for crumbs), return ErrNotFound/ErrInvalidID\n- Table.Fetch must: apply filter map with AND semantics, support entity-specific filter keys, return []any with correct concrete types, handle limit/offset\n- JSONL writes use atomic temp-file pattern: write to .tmp, fsync, rename\n- Use modernc.org/sqlite (pure Go, no CGO) per architecture technology choices\n- Use google/uuid for UUID v7 generation\n\n## Design Decisions\n- One SQLiteBackend struct holds the database connection, file handles, and table map\n- Each Table knows its entity type and dispatches to type-specific hydration/persistence/validation\n- JSONL files are the source of truth; SQLite is rebuilt from JSONL on startup\n- Immediate sync strategy for initial implementation (write JSONL on every Set/Delete)\n- Entity-specific logic (crumb property initialization, trail cascade) lives in the table's Set/Delete methods\n\n## Acceptance Criteria\n- [ ] SQLiteBackend implements Cupboard interface (compile-time assertion)\n- [ ] Attach creates DataDir, JSONL files, SQLite database, and schema\n- [ ] Attach seeds built-in properties (priority, type, description, owner, labels) and categories\n- [ ] Detach closes database and is idempotent\n- [ ] GetTable returns Table for all 6 standard names\n- [ ] Table CRUD works for Crumb entities (create with UUID v7, get, update, delete with cascade)\n- [ ] Table CRUD works for all other entity types (Trail, Property, Category, Metadata, Link, Stash)\n- [ ] JSONL round-trip: data written to JSONL can be loaded back on restart\n- [ ] Atomic write pattern prevents data corruption (temp+fsync+rename)\n- [ ] go build ./internal/sqlite succeeds\n- [ ] Integration tests verify Attach → CRUD → Detach lifecycle\n- [ ] Integration tests verify JSONL persistence survives database deletion","status":"open","priority":2,"issue_type":"task","owner":"petar.djukic@gmail.com","created_at":"2026-02-11T14:34:38.109546-05:00","created_by":"petardjukic","updated_at":"2026-02-11T14:34:38.109546-05:00","dependencies":[{"issue_id":"main-rjt","depends_on_id":"main-uik","type":"blocks","created_at":"2026-02-11T14:34:38.370087-05:00","created_by":"petardjukic"}]}
{"id":"main-uik","title":"Define core types and interfaces in pkg/types","description":"## Required Reading\n- docs/specs/product-requirements/prd001-cupboard-core.yaml (Config, Cupboard, Table interfaces, standard table names, error types)\n- docs/specs/product-requirements/prd003-crumbs-interface.yaml (Crumb struct, state values, entity methods)\n- docs/specs/product-requirements/prd004-properties-interface.yaml (Property struct, Category struct, value types)\n- docs/specs/product-requirements/prd005-metadata-interface.yaml (Metadata struct, Schema struct)\n- docs/specs/product-requirements/prd006-trails-interface.yaml (Trail struct, state values, entity methods)\n- docs/specs/product-requirements/prd007-links-interface.yaml (Link struct, link type constants)\n- docs/specs/product-requirements/prd008-stash-interface.yaml (Stash struct, StashHistoryEntry struct, stash types, entity methods)\n- docs/ARCHITECTURE.md § Main Interfaces, § System Components\n\n## Files to Create/Modify\n- pkg/types/config.go (create) — Config struct, config validation errors (ErrBackendEmpty, ErrBackendUnknown, ErrSyncStrategyUnknown, ErrBatchSizeInvalid, ErrBatchIntervalInvalid)\n- pkg/types/cupboard.go (create) — Cupboard interface (GetTable, Attach, Detach), cupboard lifecycle errors (ErrCupboardDetached, ErrAlreadyAttached, ErrTableNotFound)\n- pkg/types/table.go (create) — Table interface (Get, Set, Delete, Fetch), table operation errors (ErrNotFound, ErrInvalidID, ErrInvalidData, ErrInvalidFilter), entity method errors (ErrInvalidState, ErrInvalidTransition, ErrInvalidName, ErrPropertyNotFound, ErrTypeMismatch, ErrInvalidCategory, ErrInvalidStashType, ErrLockHeld, ErrNotLockHolder, ErrInvalidHolder, ErrAlreadyInTrail, ErrNotInTrail, ErrSchemaNotFound, ErrInvalidContent, ErrDuplicateName, ErrInvalidValueType)\n- pkg/types/crumb.go (create) — Crumb struct with fields (CrumbID, Name, State, CreatedAt, UpdatedAt, Properties), state constants, entity methods (SetState, Pebble, Dust, SetProperty, GetProperty, GetProperties, ClearProperty)\n- pkg/types/trail.go (create) — Trail struct with fields (TrailID, State, CreatedAt, CompletedAt), state constants, entity methods (Complete, Abandon)\n- pkg/types/property.go (create) — Property struct (PropertyID, Name, Description, ValueType, CreatedAt), Category struct (CategoryID, PropertyID, Name, Ordinal), value type constants, default value function, entity methods (DefineCategory, GetCategories)\n- pkg/types/metadata.go (create) — Metadata struct (MetadataID, CrumbID, TableName, Content, PropertyID, CreatedAt), Schema struct (SchemaName, Description, ContentType)\n- pkg/types/link.go (create) — Link struct (LinkID, LinkType, FromID, ToID, CreatedAt), link type constants (LinkTypeBelongsTo, LinkTypeChildOf, LinkTypeBranchesFrom, LinkTypeScopedTo)\n- pkg/types/stash.go (create) — Stash struct (StashID, Name, StashType, Value, Version, CreatedAt, LastOperation, ChangedBy), StashHistoryEntry struct, stash type constants, operation constants, entity methods (SetValue, GetValue, Increment, Acquire, Release)\n- pkg/types/tables.go (create) — Standard table name constants (crumbs, trails, properties, metadata, links, stashes)\n\n## Requirements\n- Define all entity structs per their respective PRDs with exact field names and types\n- Define the Cupboard interface with GetTable(name string) (Table, error), Attach(config Config) error, Detach() error\n- Define the Table interface with Get(id string) (any, error), Set(id string, data any) (string, error), Delete(id string) error, Fetch(filter map[string]any) ([]any, error)\n- Define all sentinel error variables in their correct files per prd001 R7\n- Define all entity methods that operate on structs in memory (state transitions, property access, stash operations)\n- Entity methods must validate state and update timestamps per their PRDs\n- Define constants for states, link types, stash types, value types, and standard table names\n- Property entity methods (DefineCategory, GetCategories) accept Cupboard parameter per prd004 R7-R8\n\n## Design Decisions\n- pkg/types is the shared contract layer — no implementation, only types, interfaces, and errors\n- Entity methods update struct fields in memory; callers persist via Table.Set\n- All IDs are strings (UUID v7 format, but generation is backend responsibility)\n- State values are strings for JSON compatibility, with constants for compile-time safety\n- Filter type is map[string]any per prd001 R3.5\n- Property methods on Crumb that need property definitions may defer validation (R5.7 permits this)\n\n## Acceptance Criteria\n- [ ] All entity structs compile with correct field names and types matching their PRDs\n- [ ] Cupboard and Table interfaces compile\n- [ ] All sentinel errors defined and checkable with errors.Is\n- [ ] Crumb.SetState validates state values and returns ErrInvalidState for invalid states\n- [ ] Crumb.Pebble returns ErrInvalidTransition when current state is not \"taken\"\n- [ ] Crumb.Dust succeeds from any state\n- [ ] Trail.Complete returns ErrInvalidState when current state is not \"active\"\n- [ ] Trail.Abandon returns ErrInvalidState when current state is not \"active\"\n- [ ] Stash.Acquire/Release validate stash type and holder\n- [ ] Stash.Increment validates stash type\n- [ ] go build ./pkg/types succeeds\n- [ ] Unit tests pass for all entity methods (state transitions, property access, stash operations)\n- [ ] Package doc comment references implemented PRDs","status":"closed","priority":2,"issue_type":"task","owner":"petar.djukic@gmail.com","created_at":"2026-02-11T14:34:37.968388-05:00","created_by":"petardjukic","updated_at":"2026-02-11T14:41:27.038848-05:00","closed_at":"2026-02-11T14:41:27.038848-05:00","close_reason":"Closed"}

{"id":"main-d6s","title":"Implement cupboard CLI with Cobra: init, version, get, set, list, delete (prd009)","description":"## Required Reading\n- docs/specs/product-requirements/prd009-cupboard-cli.yaml (all CLI commands, flags, output formats, exit codes)\n- docs/specs/product-requirements/prd010-configuration-directories.yaml (directory layout, config loading, platform defaults)\n- docs/specs/product-requirements/prd001-cupboard-core.yaml (Cupboard and Table interfaces)\n- docs/ARCHITECTURE.md § CLI Interface, § Project Structure\n- docs/specs/use-cases/rel01.1-uc004-generic-table-cli.yaml\n- docs/specs/test-suites/test-rel01.1-uc004-generic-table-cli.yaml\n- pkg/types/ (interfaces and entities from task 0)\n- internal/sqlite/ (backend from task 1)\n\n## Files to Create/Modify\n- cmd/cupboard/main.go (modify) — Replace print statement with Cobra root command setup\n- internal/cli/root.go (create) — Root command with global flags (--config-dir, --data-dir, --help), Cupboard initialization (load config, Attach, defer Detach)\n- internal/cli/version.go (create) — Version command: print version string, exit 0\n- internal/cli/init.go (create) — Init command: create config directory and config.yaml, create data directory, Attach/Detach to initialize JSONL files\n- internal/cli/get.go (create) — Get command: cupboard get \u003ctable\u003e \u003cid\u003e, output JSON, exit 1 on not found\n- internal/cli/set.go (create) — Set command: cupboard set \u003ctable\u003e \u003cid\u003e \u003cjson\u003e, parse JSON into entity, call Table.Set, output result JSON\n- internal/cli/list.go (create) — List command: cupboard list \u003ctable\u003e [key=value...], parse key=value filters, call Table.Fetch, output JSON array\n- internal/cli/delete.go (create) — Delete command: cupboard delete \u003ctable\u003e \u003cid\u003e, call Table.Delete, output confirmation\n- internal/paths/paths.go (create) — Platform-specific default directories per prd010: config dir and data dir resolution with CLI flag \u003e env var \u003e platform default precedence\n- tests/integration/test_rel01_1_uc004_generic_table_cli_test.go (create) — Integration tests: init creates JSONL files, set creates crumb and returns JSON, get retrieves crumb, list returns array, list with filter returns subset, delete removes crumb\n- go.mod (modify) — Add spf13/cobra dependency\n\n## Requirements\n- Root command with --config-dir and --data-dir global flags per prd009\n- cupboard version prints version string per prd009 R1\n- cupboard init creates config and data directories per prd010 R1, R2\n- cupboard get \u003ctable\u003e \u003cid\u003e retrieves entity and prints JSON per prd009 R3.1\n- cupboard set \u003ctable\u003e \u003cid\u003e \u003cjson\u003e creates or updates entity per prd009 R3.2 (empty id for create)\n- cupboard list \u003ctable\u003e [key=value...] queries and prints JSON array per prd009 R3.3\n- cupboard delete \u003ctable\u003e \u003cid\u003e removes entity per prd009 R3.4\n- JSON output: pretty-printed with 2-space indent\n- Exit codes: 0 success, 1 user error, 2 system error per prd009\n- Path resolution: --data-dir flag \u003e config.yaml data_dir \u003e platform default per prd010\n- Config directory default: $(CWD)/.crumbs per prd010\n- Data directory default: $(CWD)/.crumbs-db per prd010\n\n## Design Decisions\n- Use spf13/cobra for CLI framework per go-style standard ecosystem\n- internal/cli/ package for all command implementations\n- internal/paths/ package for directory resolution\n- Each command file registers itself with the root command\n- Cupboard Attach happens in PersistentPreRunE on root; Detach in PersistentPostRunE\n- Start with generic table commands only; crumb-specific and issue-tracking commands in later tasks\n- JSON output only for this task (human-readable tables in a future task)\n\n## Acceptance Criteria\n- [ ] cupboard version prints version and exits 0\n- [ ] cupboard init creates .crumbs/ (config) and .crumbs-db/ (data) directories\n- [ ] cupboard init creates config.yaml with backend: sqlite\n- [ ] cupboard set crumbs '' '{\"Name\":\"Test\"}' creates a crumb and prints JSON with CrumbID\n- [ ] cupboard get crumbs \u003cid\u003e retrieves the crumb and prints JSON\n- [ ] cupboard list crumbs prints JSON array of all crumbs\n- [ ] cupboard list crumbs State=draft filters by state\n- [ ] cupboard delete crumbs \u003cid\u003e removes the crumb\n- [ ] cupboard get crumbs \u003cmissing-id\u003e exits with code 1\n- [ ] --data-dir flag overrides default data directory\n- [ ] Integration tests pass\n- [ ] go build ./cmd/cupboard produces working binary\n- [ ] go vet ./... passes","status":"open","priority":2,"issue_type":"task","owner":"petar.djukic@gmail.com","created_at":"2026-02-11T14:28:48.996002-05:00","created_by":"petardjukic","updated_at":"2026-02-11T14:28:48.996002-05:00","dependencies":[{"issue_id":"main-d6s","depends_on_id":"main-ttk","type":"blocks","created_at":"2026-02-11T14:28:49.19238-05:00","created_by":"petardjukic"}]}
{"id":"main-qwd","title":"Implement types package: interfaces, entities, and errors (prd001, prd003)","description":"## Required Reading\n- docs/specs/product-requirements/prd001-cupboard-core.yaml (Config, Cupboard, Table interfaces, error types)\n- docs/specs/product-requirements/prd003-crumbs-interface.yaml (Crumb struct, state values, entity methods, filter map)\n- docs/ARCHITECTURE.md § Main Interfaces, § Entity Types\n\n## Files to Create/Modify\n- pkg/types/config.go (create) — Config struct, SQLiteConfig, config validation errors\n- pkg/types/cupboard.go (create) — Cupboard interface, lifecycle errors (ErrCupboardDetached, ErrAlreadyAttached, ErrTableNotFound)\n- pkg/types/table.go (create) — Table interface (Get, Set, Delete, Fetch), table operation errors (ErrNotFound, ErrInvalidID, ErrInvalidData), entity method errors (ErrInvalidState, ErrInvalidTransition, ErrInvalidName, ErrPropertyNotFound, ErrTypeMismatch, ErrInvalidCategory, ErrInvalidStashType, ErrLockHeld, ErrNotLockHolder, ErrInvalidHolder, ErrAlreadyInTrail, ErrNotInTrail, ErrSchemaNotFound, ErrInvalidContent, ErrInvalidFilter)\n- pkg/types/crumb.go (create) — Crumb struct (CrumbID, Name, State, CreatedAt, UpdatedAt, Properties), state constants (draft, pending, ready, taken, pebble, dust), entity methods (SetState, Pebble, Dust, SetProperty, GetProperty, GetProperties, ClearProperty)\n- pkg/types/crumb_test.go (create) — Tests for Crumb entity methods: SetState validation, Pebble from taken only, Dust from any state, property methods\n- pkg/types/trail.go (create) — Trail struct (TrailID, State, CreatedAt, CompletedAt), state constants, Complete/Abandon methods\n- pkg/types/property.go (create) — Property struct, Category struct, value type constants, DefineCategory/GetCategories methods\n- pkg/types/metadata.go (create) — Metadata struct (MetadataID, CrumbID, TableName, Content, PropertyID, CreatedAt)\n- pkg/types/link.go (create) — Link struct (LinkID, LinkType, FromID, ToID, CreatedAt), link type constants\n- pkg/types/stash.go (create) — Stash struct (StashID, Name, StashType, Value, Version, CreatedAt, LastOperation, ChangedBy), stash type constants, entity methods\n- go.mod (modify) — Add google/uuid dependency for UUID v7\n\n## Requirements\n- Define all interfaces and entities per prd001-cupboard-core and prd003-crumbs-interface\n- Config struct with Backend, DataDir, SQLiteConfig fields per R1\n- Cupboard interface with GetTable, Attach, Detach per R2\n- Table interface with Get, Set, Delete, Fetch per R3\n- Standard table name constants per R2.5 (crumbs, trails, properties, metadata, links, stashes)\n- All sentinel error types per R7 (both cupboard lifecycle and table operation errors)\n- Crumb struct with all fields per prd003 R1, state values per R2, entity methods per R4 and R5\n- Trail, Property, Category, Metadata, Link, Stash structs with fields per their respective PRDs\n- UUID v7 helper function for ID generation per R8\n- Filter type alias per prd003 R9.1\n\n## Design Decisions\n- pkg/types is the public contract layer; no implementation logic beyond entity methods\n- Entity methods mutate struct fields in memory; caller persists via Table.Set\n- State stored as string for JSON compatibility\n- Properties map is map[string]any keyed by property_id\n- Interfaces use any for entity parameters; callers type-assert\n- Property validation in SetProperty/ClearProperty deferred to Table.Set (simpler approach per prd003 R5.7)\n\n## Acceptance Criteria\n- [ ] All interfaces compile and match PRD signatures exactly\n- [ ] All sentinel errors defined and checkable with errors.Is\n- [ ] Crumb.SetState validates state values, returns ErrInvalidState for unknown states\n- [ ] Crumb.Pebble returns ErrInvalidTransition when state is not taken\n- [ ] Crumb.Dust works from any state, is idempotent\n- [ ] All entity methods update UpdatedAt\n- [ ] Unit tests cover state transition methods (happy path and error cases)\n- [ ] go build ./... succeeds\n- [ ] go vet ./... passes","status":"in_progress","priority":2,"issue_type":"task","owner":"petar.djukic@gmail.com","created_at":"2026-02-11T14:28:48.728448-05:00","created_by":"petardjukic","updated_at":"2026-02-11T14:28:54.934131-05:00"}
{"id":"main-ttk","title":"Implement SQLite backend: Cupboard, Table, JSONL persistence (prd002)","description":"## Required Reading\n- docs/specs/product-requirements/prd002-sqlite-backend.yaml (directory layout, JSONL format, SQLite schema, startup/shutdown, write operations, entity hydration/persistence)\n- docs/specs/product-requirements/prd001-cupboard-core.yaml (Cupboard and Table interface contracts)\n- docs/specs/product-requirements/prd003-crumbs-interface.yaml (Crumb struct, filter map, creation behavior)\n- docs/ARCHITECTURE.md § SQLite Backend, § Design Decisions\n- pkg/types/ (all files from task 0)\n- docs/specs/use-cases/rel01.0-uc001-cupboard-lifecycle.yaml\n- docs/specs/use-cases/rel01.0-uc002-table-crud.yaml\n- docs/specs/use-cases/rel01.0-uc003-crumb-lifecycle.yaml\n- docs/specs/test-suites/test-rel01.0-uc001-cupboard-lifecycle.yaml\n- docs/specs/test-suites/test-rel01.0-uc002-table-crud.yaml\n- docs/specs/test-suites/test-rel01.0-uc003-crumb-lifecycle.yaml\n\n## Files to Create/Modify\n- internal/sqlite/backend.go (create) — SQLite backend struct implementing Cupboard interface: Attach (create DataDir, create JSONL files, init SQLite, load JSONL), Detach (flush, delete cupboard.db), GetTable (route to table implementations)\n- internal/sqlite/table.go (create) — Generic table implementation satisfying Table interface, with entity hydration/persistence logic for Crumb type (Get, Set, Delete, Fetch)\n- internal/sqlite/jsonl.go (create) — JSONL reader/writer: read lines into entities, write entities as JSONL with atomic writes (temp file, fsync, rename)\n- internal/sqlite/schema.go (create) — SQLite schema creation (CREATE TABLE for crumbs; indexes for state, created_at)\n- internal/sqlite/backend_test.go (create) — Tests for Cupboard lifecycle: Attach creates DataDir and JSONL files, Attach idempotent (ErrAlreadyAttached), Detach releases resources, operations after Detach return ErrCupboardDetached\n- internal/sqlite/table_test.go (create) — Tests for Table CRUD on crumbs: Set with empty ID creates crumb with UUID v7, Get retrieves by ID, Get returns ErrNotFound, Delete removes crumb, Fetch with empty filter returns all, Fetch with state filter, Fetch returns empty slice not nil\n- go.mod (modify) — Add mattn/go-sqlite3 dependency\n\n## Requirements\n- Backend implements types.Cupboard interface\n- Attach: validate config, create DataDir if missing, create empty JSONL files if missing, create SQLite schema, load JSONL into SQLite\n- Detach: flush pending writes, delete cupboard.db, mark as detached\n- GetTable: return Table for standard names (start with \"crumbs\" only), return ErrTableNotFound for unknown names\n- Table.Set with empty ID: generate UUID v7, set State to draft, set timestamps, persist to SQLite and JSONL\n- Table.Set with existing ID: update entity in SQLite and JSONL\n- Table.Get: query SQLite, hydrate to *Crumb, return ErrNotFound if missing\n- Table.Delete: remove from SQLite and JSONL, return ErrNotFound if missing\n- Table.Fetch: query SQLite with filter (states, limit, offset), hydrate results to []*Crumb\n- JSONL atomic writes: write to temp file, fsync, rename (per prd002 R5)\n- Immediate sync strategy (write JSONL after every commit)\n- Name validation on Set (ErrInvalidName if empty)\n\n## Design Decisions\n- Start with crumbs table only; other entity tables added in later tasks\n- Use database/sql with mattn/go-sqlite3 CGO driver\n- JSONL is source of truth; SQLite is rebuilt from JSONL on every Attach\n- Single-writer model; no concurrent access support needed yet\n- Entity hydration maps SQLite rows to Crumb structs; entity persistence maps structs to JSONL lines\n- Filter map translated to SQL WHERE clauses\n\n## Acceptance Criteria\n- [ ] Attach creates DataDir and JSONL files when they do not exist\n- [ ] Attach loads existing JSONL data into SQLite\n- [ ] Attach on already-attached returns ErrAlreadyAttached\n- [ ] Detach deletes cupboard.db\n- [ ] Operations after Detach return ErrCupboardDetached\n- [ ] Table.Set with empty ID creates crumb with UUID v7, state=draft, timestamps set\n- [ ] Table.Get retrieves crumb by ID\n- [ ] Table.Get returns ErrNotFound for missing ID\n- [ ] Table.Delete removes crumb\n- [ ] Table.Fetch with empty filter returns all crumbs\n- [ ] Table.Fetch with state filter returns matching crumbs only\n- [ ] JSONL file contains persisted data after Set\n- [ ] Data survives Detach and re-Attach (JSONL round-trip)\n- [ ] go test ./internal/sqlite/... passes\n- [ ] go vet ./... passes","status":"open","priority":2,"issue_type":"task","owner":"petar.djukic@gmail.com","created_at":"2026-02-11T14:28:48.861375-05:00","created_by":"petardjukic","updated_at":"2026-02-11T14:28:48.861375-05:00","dependencies":[{"issue_id":"main-ttk","depends_on_id":"main-qwd","type":"blocks","created_at":"2026-02-11T14:28:49.094936-05:00","created_by":"petardjukic"}]}

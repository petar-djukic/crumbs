{"id":"generation-2026-02-11-17-26-8oh","title":"Implement SQLite backend with Cupboard lifecycle and crumbs table","description":"## Required Reading\n- pkg/types/ (all files created in task 0) — interfaces and types to implement\n- docs/specs/product-requirements/prd002-sqlite-backend.yaml (directory layout R1, JSONL format R2, SQLite schema R3, startup sequence R4, write operations R5, shutdown R6)\n- docs/specs/product-requirements/prd001-cupboard-core.yaml (Attach R4, Detach R5, GetTable R2, error handling R6-R7, UUID R8)\n- docs/specs/product-requirements/prd003-crumbs-interface.yaml (Crumb creation R3, JSONL serialization)\n- docs/specs/product-requirements/prd010-configuration-directories.yaml (data directory R2, JSONL file layout R4)\n- docs/specs/use-cases/rel01.0-uc001-cupboard-lifecycle.yaml (success criteria S1-S3)\n- docs/specs/use-cases/rel01.0-uc002-table-crud.yaml (success criteria for Set, Get, Fetch, Delete)\n- docs/ARCHITECTURE.md § SQLite Backend, § Design Decisions\n\n## Files to Create/Modify\n- internal/sqlite/backend.go (create) — SQLiteBackend struct implementing Cupboard interface; Attach (create DataDir, create empty JSONL files, open SQLite, load JSONL into SQLite); Detach (flush, close); GetTable dispatching to table implementations; attached/detached state tracking per prd001 R6\n- internal/sqlite/crumbs_table.go (create) — crumbsTable struct implementing Table interface for the crumbs table; Get (query SQLite by ID, hydrate Crumb); Set (validate Name, generate UUID v7 if empty, set timestamps, write to SQLite and append JSONL); Delete (remove from SQLite and rewrite JSONL); Fetch (query SQLite with filter map, hydrate results)\n- internal/sqlite/jsonl.go (create) — JSONL read/write helpers: ReadJSONL (parse file into slice of JSON objects), WriteJSONL (rewrite full file), AppendJSONL (append single line); uses encoding/json\n- internal/sqlite/backend_test.go (create) — Tests for Attach/Detach lifecycle, GetTable, post-detach errors\n- internal/sqlite/crumbs_table_test.go (create) — Tests for crumbs table: create with empty ID (UUID generated, state=draft, timestamps set), get by ID, update existing, delete, fetch all, fetch with filter, not-found errors, invalid name error\n- go.mod, go.sum (modify) — Add dependencies: github.com/mattn/go-sqlite3, github.com/google/uuid\n\n## Requirements\n- SQLiteBackend implements types.Cupboard interface\n- Attach: validates config, creates DataDir if missing, creates empty JSONL files per prd002 R1.3-R1.4, opens SQLite in DataDir, creates schema, loads existing JSONL data into SQLite per prd002 R4\n- Attach is idempotent (returns ErrAlreadyAttached) per prd001 R4.4\n- Detach: closes SQLite, marks as detached per prd001 R5; idempotent per R5.2\n- All operations after Detach return ErrCupboardDetached per prd001 R6\n- GetTable returns crumbsTable for \"crumbs\"; returns ErrTableNotFound for unknown names\n- crumbsTable.Set with empty ID: generates UUID v7, sets State=draft, sets CreatedAt/UpdatedAt, validates Name non-empty\n- crumbsTable.Set with existing ID: updates entity, updates UpdatedAt\n- crumbsTable.Get returns hydrated Crumb or ErrNotFound\n- crumbsTable.Fetch with empty filter returns all; with filter matches field values\n- crumbsTable.Delete removes entity or returns ErrNotFound\n- JSONL helpers handle read/write/append with proper newline termination\n\n## Design Decisions\n- Start with crumbs table only; other tables (trails, properties, etc.) follow the same pattern and will be added in later tasks\n- GetTable returns ErrTableNotFound for non-crumbs tables until they are implemented\n- SQLite schema: single crumbs table with columns matching Crumb struct fields; properties stored as JSON text column\n- JSONL append for Set; full rewrite for Delete (keeps file consistent)\n- Use database/sql with mattn/go-sqlite3 driver\n- Use google/uuid for UUID v7 generation\n\n## Acceptance Criteria\n- [ ] SQLiteBackend satisfies types.Cupboard interface (compile-time check)\n- [ ] Attach creates DataDir and JSONL files when they don't exist\n- [ ] Attach loads existing JSONL data into SQLite on startup\n- [ ] Detach closes SQLite; subsequent operations return ErrCupboardDetached\n- [ ] GetTable(\"crumbs\") returns a working Table\n- [ ] GetTable(\"unknown\") returns ErrTableNotFound\n- [ ] Set with empty ID creates crumb with UUID v7, state=draft, timestamps\n- [ ] Set with empty Name returns ErrInvalidName\n- [ ] Set with existing ID updates the crumb\n- [ ] Get retrieves crumb by ID; returns ErrNotFound for missing ID\n- [ ] Fetch with empty filter returns all crumbs\n- [ ] Fetch with State filter returns matching crumbs\n- [ ] Delete removes crumb; returns ErrNotFound for missing ID\n- [ ] JSONL file contains crumb data after Set\n- [ ] go test ./internal/sqlite/... passes\n- [ ] go build ./cmd/cupboard succeeds","status":"open","priority":2,"issue_type":"task","owner":"petar.djukic@gmail.com","created_at":"2026-02-11T17:29:50.499298-05:00","created_by":"petardjukic","updated_at":"2026-02-11T17:29:50.499298-05:00","dependencies":[{"issue_id":"generation-2026-02-11-17-26-8oh","depends_on_id":"generation-2026-02-11-17-26-vvo","type":"blocks","created_at":"2026-02-11T17:29:50.594604-05:00","created_by":"petardjukic"}]}
{"id":"generation-2026-02-11-17-26-vvo","title":"Define core types and interfaces in pkg/types","description":"## Required Reading\n- docs/specs/product-requirements/prd001-cupboard-core.yaml (Config, Cupboard interface, Table interface, error types, UUID v7)\n- docs/specs/product-requirements/prd003-crumbs-interface.yaml (Crumb struct, state values, state transition methods)\n- docs/specs/product-requirements/prd002-sqlite-backend.yaml (JSONL format, entity hydration context)\n- docs/ARCHITECTURE.md § System Overview, § Main Interfaces\n\n## Files to Create/Modify\n- pkg/types/config.go (create) — Config struct with Backend and DataDir fields; config validation function; config error sentinels (ErrBackendEmpty, ErrBackendUnknown, ErrSyncStrategyUnknown, ErrBatchSizeInvalid, ErrBatchIntervalInvalid)\n- pkg/types/cupboard.go (create) — Cupboard interface (GetTable, Attach, Detach); cupboard error sentinels (ErrCupboardDetached, ErrAlreadyAttached, ErrTableNotFound); standard table name constants\n- pkg/types/table.go (create) — Table interface (Get, Set, Delete, Fetch); table error sentinels (ErrNotFound, ErrInvalidID, ErrInvalidData); entity method error sentinels (ErrInvalidState, ErrInvalidTransition, ErrInvalidName, ErrPropertyNotFound, ErrTypeMismatch, ErrInvalidCategory, ErrInvalidStashType, ErrLockHeld, ErrNotLockHolder, ErrInvalidHolder, ErrAlreadyInTrail, ErrNotInTrail, ErrSchemaNotFound, ErrInvalidContent, ErrInvalidFilter)\n- pkg/types/crumb.go (create) — Crumb struct (CrumbID, Name, State, CreatedAt, UpdatedAt, Properties); valid state constants (draft, pending, ready, taken, pebble, dust); state transition methods (SetState, Pebble, Dust) per prd003 R4\n- pkg/types/config_test.go (create) — Tests for Config validation\n- pkg/types/crumb_test.go (create) — Tests for Crumb state transitions (SetState, Pebble, Dust, idempotency, invalid transitions)\n\n## Requirements\n- Define Config struct per prd001-cupboard-core R1 (Backend string, DataDir string)\n- Config.Validate() returns appropriate errors per R1.2, R1.3, R1.4\n- Define Cupboard interface per prd001 R2 (GetTable, Attach, Detach)\n- Define Table interface per prd001 R3 (Get returns any, Set returns string+error, Delete, Fetch with map[string]any filter)\n- Define all standard error sentinels from prd001 R7\n- Define six standard table name constants per prd001 R2.5\n- Define Crumb struct per prd003 R1.1 with JSON tags for JSONL serialization\n- Implement Crumb.SetState per prd003 R4.2 (validate state, update State and UpdatedAt, idempotent)\n- Implement Crumb.Pebble per prd003 R4.3 (only from taken state)\n- Implement Crumb.Dust per prd003 R4.4 (from any state, idempotent)\n\n## Design Decisions\n- pkg/types holds interfaces and structs only; no implementation\n- Table interface uses `any` for entity types per prd001 R3.6; callers use type assertions\n- Crumb state is a string, not an enum, for JSON compatibility per prd003 R2.4\n- JSON tags use snake_case to match JSONL format in prd002 R2.2 (crumb_id, created_at, etc.)\n- State transition methods modify the struct in memory; caller must call Table.Set to persist per prd003 R4.5\n\n## Acceptance Criteria\n- [ ] Config struct has Backend and DataDir fields\n- [ ] Config.Validate() rejects empty backend, unknown backend, empty DataDir for sqlite\n- [ ] Cupboard interface has GetTable, Attach, Detach methods with correct signatures\n- [ ] Table interface has Get(string)(any,error), Set(string,any)(string,error), Delete(string)error, Fetch(map[string]any)([]any,error)\n- [ ] All 20 error sentinels from prd001 R7 defined\n- [ ] Six table name constants defined (crumbs, trails, properties, metadata, links, stashes)\n- [ ] Crumb struct has all fields from prd003 R1.1 with snake_case JSON tags\n- [ ] SetState validates against the six valid states and returns ErrInvalidState for unknown\n- [ ] Pebble returns ErrInvalidTransition when current state is not taken\n- [ ] Dust succeeds from any state and is idempotent\n- [ ] All state methods update UpdatedAt\n- [ ] go build ./pkg/types succeeds\n- [ ] go test ./pkg/types/... passes","status":"closed","priority":2,"issue_type":"task","owner":"petar.djukic@gmail.com","created_at":"2026-02-11T17:29:50.369622-05:00","created_by":"petardjukic","updated_at":"2026-02-11T17:33:06.788036-05:00","closed_at":"2026-02-11T17:33:06.788036-05:00","close_reason":"Closed"}

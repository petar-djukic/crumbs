{"id":"generation-2026-02-11-19-09-8av","title":"Define types and interfaces in pkg/types","description":"## Required Reading\n- docs/ARCHITECTURE.md (System Overview, Main Interface, Entity Types, Design Decisions)\n- docs/specs/product-requirements/prd001-cupboard-core.yaml (R1-R8: Config, Cupboard interface, Table interface, errors, UUID v7)\n- docs/specs/product-requirements/prd003-crumbs-interface.yaml (R1-R2, R4-R5: Crumb struct, states, entity methods)\n- docs/specs/product-requirements/prd006-trails-interface.yaml (Trail struct, Complete/Abandon methods)\n- docs/specs/product-requirements/prd004-properties-interface.yaml (Property and Category structs, value types)\n- docs/specs/product-requirements/prd005-metadata-interface.yaml (Metadata struct, Schema struct)\n- docs/specs/product-requirements/prd007-links-interface.yaml (Link struct, link types)\n- docs/specs/product-requirements/prd008-stash-interface.yaml (Stash struct, StashHistoryEntry, stash types, entity methods)\n- docs/specs/product-requirements/prd002-sqlite-backend.yaml (R1.2: SQLiteConfig for sync strategy)\n- pkg/crumbs/version.go (existing code)\n- cmd/cupboard/main.go (existing code)\n\n## Files to Create/Modify\n- pkg/types/config.go (create) — Config struct, SQLiteConfig struct, Validate methods, config errors\n- pkg/types/cupboard.go (create) — Cupboard interface, lifecycle errors (ErrCupboardDetached, ErrAlreadyAttached, ErrTableNotFound)\n- pkg/types/table.go (create) — Table interface, table operation errors (ErrNotFound, ErrInvalidID, ErrInvalidData), entity method errors (ErrInvalidState, ErrInvalidTransition, ErrInvalidName, etc.)\n- pkg/types/crumb.go (create) — Crumb struct with fields (CrumbID, Name, State, CreatedAt, UpdatedAt, Properties), state constants, entity methods (SetState, Pebble, Dust, SetProperty, GetProperty, GetProperties, ClearProperty)\n- pkg/types/trail.go (create) — Trail struct with fields (TrailID, State, CreatedAt, CompletedAt), state constants, entity methods (Complete, Abandon)\n- pkg/types/property.go (create) — Property struct, Category struct, value type constants\n- pkg/types/metadata.go (create) — Metadata struct, Schema struct\n- pkg/types/link.go (create) — Link struct, link type constants\n- pkg/types/stash.go (create) — Stash struct, StashHistoryEntry struct, stash type constants, entity methods (SetValue, GetValue, Increment, Acquire, Release)\n\n## Requirements\n- Define Config struct with Backend, DataDir, and SQLiteConfig fields per prd001-cupboard-core R1\n- Define SQLiteConfig with SyncStrategy, BatchSize, BatchInterval per prd002-sqlite-backend R16\n- Define Cupboard interface with GetTable, Attach, Detach per prd001-cupboard-core R2\n- Define Table interface with Get, Set, Delete, Fetch per prd001-cupboard-core R3\n- Define all sentinel errors per prd001-cupboard-core R7 (config errors in config.go, lifecycle errors in cupboard.go, table/entity errors in table.go)\n- Define Crumb struct per prd003-crumbs-interface R1 with entity methods per R4 (SetState, Pebble, Dust) and R5 (SetProperty, GetProperty, GetProperties, ClearProperty)\n- Define Trail struct per prd006-trails-interface with entity methods (Complete, Abandon)\n- Define Property struct and Category struct per prd004-properties-interface\n- Define Metadata struct and Schema struct per prd005-metadata-interface\n- Define Link struct per prd007-links-interface with link type constants\n- Define Stash struct and StashHistoryEntry struct per prd008-stash-interface with entity methods\n- All entity methods modify struct fields in memory; callers persist via Table.Set\n- State validation in entity methods (Pebble requires taken state; Dust from any state)\n- Standard table names as constants: crumbs, trails, properties, metadata, links, stashes\n\n## Design Decisions\n- All types in pkg/types (shared public API, no implementation)\n- Entity methods on pointer receivers\n- Errors as package-level vars (sentinel errors, checkable with errors.Is)\n- State values as string constants (not enums) for JSON compatibility\n- Properties map on Crumb is map[string]any (property_id to value)\n- Table interface returns any; callers type-assert\n\n## Acceptance Criteria\n- [ ] go build ./pkg/types compiles without errors\n- [ ] Config.Validate() returns appropriate errors for empty backend, unknown backend, empty DataDir\n- [ ] All 6 standard table names defined as constants\n- [ ] All sentinel errors defined and checkable with errors.Is\n- [ ] Crumb.SetState validates state values and returns ErrInvalidState for unknown states\n- [ ] Crumb.Pebble returns ErrInvalidTransition if current state is not taken\n- [ ] Crumb.Dust succeeds from any state\n- [ ] Trail.Complete and Trail.Abandon update state fields\n- [ ] Stash entity methods (SetValue, Increment, Acquire, Release) update struct fields\n- [ ] All entity methods update UpdatedAt timestamp\n- [ ] Package doc comments reference implemented PRDs","status":"closed","priority":2,"issue_type":"task","owner":"petar.djukic@gmail.com","created_at":"2026-02-11T19:13:10.534309-05:00","created_by":"petardjukic","updated_at":"2026-02-11T19:17:00.812069-05:00","closed_at":"2026-02-11T19:17:00.812069-05:00","close_reason":"Closed"}
{"id":"generation-2026-02-11-19-09-wtc","title":"Implement SQLite backend in internal/sqlite","description":"## Required Reading\n- docs/ARCHITECTURE.md (SQLite Backend component, Design Decisions 6, 9, 10)\n- docs/specs/product-requirements/prd002-sqlite-backend.yaml (R1-R16: full backend spec)\n- docs/specs/product-requirements/prd001-cupboard-core.yaml (R2-R8: interface contract)\n- docs/specs/product-requirements/prd003-crumbs-interface.yaml (R3, R6-R10: crumb CRUD via Table)\n- docs/specs/use-cases/rel01.0-uc001-cupboard-lifecycle.yaml (Attach/Detach flow)\n- docs/specs/use-cases/rel01.0-uc002-table-crud.yaml (Set, Get, Fetch, Delete flow)\n- docs/specs/use-cases/rel01.0-uc003-crumb-lifecycle.yaml (state transitions via Table.Set)\n- docs/specs/test-suites/test-rel01.0-uc001-cupboard-lifecycle.yaml (test cases for lifecycle)\n- docs/specs/test-suites/test-rel01.0-uc002-table-crud.yaml (test cases for CRUD)\n- docs/specs/test-suites/test-rel01.0-uc003-crumb-lifecycle.yaml (test cases for crumb lifecycle)\n- pkg/types/ (all type definitions from task 0)\n\n## Files to Create/Modify\n- internal/sqlite/backend.go (create) — Backend struct implementing Cupboard interface, Attach/Detach, GetTable routing\n- internal/sqlite/table.go (create) — Table struct implementing Table interface, entity-type-agnostic CRUD dispatcher\n- internal/sqlite/schema.go (create) — SQLite schema creation (CREATE TABLE, indexes per prd002 R3)\n- internal/sqlite/jsonl.go (create) — JSONL read/write utilities (load, atomic write, per-table persistence)\n- internal/sqlite/hydrate.go (create) — Entity hydration (SQLite rows to entity structs) and dehydration (entity structs to SQL params) per prd002 R14-R15\n- internal/sqlite/seed.go (create) — Built-in property and category seeding per prd002 R9\n- tests/integration/test_rel01_0_uc001_cupboard_lifecycle_test.go (create) — Integration tests for Attach/Detach/GetTable\n- tests/integration/test_rel01_0_uc002_table_crud_test.go (create) — Integration tests for Set/Get/Delete/Fetch across entity types\n- tests/integration/test_rel01_0_uc003_crumb_lifecycle_test.go (create) — Integration tests for crumb state transitions\n- go.mod (modify) — Add modernc.org/sqlite, google/uuid, stretchr/testify dependencies\n\n## Requirements\n- Implement Backend struct with sync.RWMutex, attached flag, config, *sql.DB, table map\n- NewBackend() factory function returns *Backend\n- Attach: validate config, create DataDir, create empty JSONL files, delete old cupboard.db, create schema, load JSONL, seed built-in properties (first run only)\n- Detach: wait for in-flight ops, close SQLite, mark detached, idempotent\n- GetTable: route table name to cached Table instance, return ErrTableNotFound for unknown names\n- Table.Get: query SQLite by primary key, hydrate to entity struct, return ErrNotFound/ErrInvalidID\n- Table.Set: type-assert entity, generate UUID v7 if ID empty, set timestamps, validate (Name non-empty for crumbs), dehydrate to SQL, INSERT or UPDATE, persist JSONL atomically\n- Table.Delete: delete from SQLite, persist JSONL, cascade for crumbs (delete properties, metadata, links), return ErrNotFound/ErrInvalidID\n- Table.Fetch: build WHERE from filter map, query SQLite, hydrate each row, return []any\n- JSONL atomic write: write to temp file, fsync, rename\n- JSONL load: read file line by line, parse JSON, insert into SQLite\n- Hydration per prd002 R14 (row to struct for each entity type)\n- Dehydration per prd002 R15 (struct to SQL params for each entity type)\n- Concurrency: RWMutex (exclusive write, concurrent reads) per prd002 R8\n- All operations check attached state, return ErrCupboardDetached if detached\n- Immediate sync strategy by default per prd002 R16\n\n## Design Decisions\n- Use modernc.org/sqlite (pure Go, no CGO) per ARCHITECTURE technology choices\n- Use google/uuid for UUID v7 generation\n- Single Backend struct implements Cupboard; single Table struct with tableName field dispatches to entity-specific hydrate/dehydrate\n- Table accessors created once during Attach, cached in map\n- Filter map translated to SQL WHERE clauses with parameterized queries\n- Crumb filter supports: states ([]string), trail_id (string via JOIN on links), limit (int), offset (int)\n\n## Acceptance Criteria\n- [ ] go build ./internal/sqlite compiles without errors\n- [ ] go test ./tests/integration/... passes all test cases\n- [ ] Attach creates DataDir and JSONL files when they do not exist\n- [ ] Attach on already-attached backend returns ErrAlreadyAttached\n- [ ] Detach releases resources; subsequent ops return ErrCupboardDetached\n- [ ] GetTable returns Table for all 6 standard table names\n- [ ] GetTable returns ErrTableNotFound for unknown names\n- [ ] Table.Set with empty ID generates UUID v7 and creates entity\n- [ ] Table.Set with existing ID updates entity\n- [ ] Table.Get retrieves entity by ID with correct type\n- [ ] Table.Delete removes entity and returns ErrNotFound for missing ID\n- [ ] Table.Fetch with empty filter returns all entities\n- [ ] Table.Fetch with states filter returns matching crumbs\n- [ ] Crumb state transitions (draft→taken→pebble) work via Set\n- [ ] JSONL files persist data (delete cupboard.db, re-Attach, data survives)\n- [ ] Built-in properties seeded on first startup (priority, type, description, owner, labels)\n- [ ] mage test passes","status":"open","priority":2,"issue_type":"task","owner":"petar.djukic@gmail.com","created_at":"2026-02-11T19:13:10.671736-05:00","created_by":"petardjukic","updated_at":"2026-02-11T19:13:10.671736-05:00","dependencies":[{"issue_id":"generation-2026-02-11-19-09-wtc","depends_on_id":"generation-2026-02-11-19-09-8av","type":"blocks","created_at":"2026-02-11T19:13:10.770224-05:00","created_by":"petardjukic"}]}

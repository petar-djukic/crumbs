id: test-rel01.1-uc001-go-install
title: Go install and basic operations
description: >
  Validates that the cupboard CLI can be installed via go install and that basic
  operations work: help, init, set, and list. This confirms the module is
  installable from the Go toolchain and the binary is usable from $GOBIN.
traces:
  - rel01.1-uc001-go-install
tags:
  - cli
  - install
  - smoke

preconditions:
  - Go toolchain installed (version 1.25 or later)
  - $GOBIN is in $PATH (typically ~/go/bin)
  - Network access to Go module proxy (for go install)
  - No existing cupboard installation in $GOBIN

test_cases:

  # --- S1: go install completes without errors ---

  - name: Go install completes successfully
    description: >
      The go install command downloads the module from the Go proxy, compiles
      cmd/cupboard, and places the binary in $GOBIN. This validates that the
      module is properly published and installable.
    inputs:
      command: go install github.com/mesh-intelligence/crumbs/cmd/cupboard@latest
    expected:
      exit_code: 0

  - name: Binary exists in GOBIN after install
    description: >
      After go install, the cupboard binary must exist in $GOBIN.
    inputs:
      command: test -x "${GOBIN:-$(go env GOBIN)}/cupboard" || test -x "$(go env GOPATH)/bin/cupboard"
    expected:
      exit_code: 0

  # --- S2: cupboard --help prints usage ---

  - name: Help flag prints usage
    description: >
      The --help flag must print usage information showing available commands.
    inputs:
      command: cupboard --help
    expected:
      exit_code: 0
      stdout_contains: "Usage:"

  - name: Help shows init command
    inputs:
      command: cupboard --help
    expected:
      exit_code: 0
      stdout_contains: "init"

  - name: Help shows set command
    inputs:
      command: cupboard --help
    expected:
      exit_code: 0
      stdout_contains: "set"

  - name: Help shows list command
    inputs:
      command: cupboard --help
    expected:
      exit_code: 0
      stdout_contains: "list"

  - name: Help shows get command
    inputs:
      command: cupboard --help
    expected:
      exit_code: 0
      stdout_contains: "get"

  # --- S3: cupboard init creates data directory ---

  - name: Init creates data directory
    description: >
      Running cupboard init in a project directory creates the data directory.
      The directory layout follows prd-configuration-directories R2.
    inputs:
      command: cupboard init --data-dir ${tmpdir}/cupboard-data && test -d ${tmpdir}/cupboard-data
    expected:
      exit_code: 0

  - name: Init creates crumbs.jsonl file
    description: >
      The init command creates the JSONL files for entity storage. The crumbs
      table is stored in crumbs.jsonl.
    inputs:
      setup:
        - cupboard init --data-dir ${tmpdir}/cupboard-data
      command: test -f ${tmpdir}/cupboard-data/crumbs.jsonl
    expected:
      exit_code: 0

  - name: Init creates trails.jsonl file
    inputs:
      setup:
        - cupboard init --data-dir ${tmpdir}/cupboard-data
      command: test -f ${tmpdir}/cupboard-data/trails.jsonl
    expected:
      exit_code: 0

  - name: Init creates properties.jsonl file
    inputs:
      setup:
        - cupboard init --data-dir ${tmpdir}/cupboard-data
      command: test -f ${tmpdir}/cupboard-data/properties.jsonl
    expected:
      exit_code: 0

  - name: Init creates links.jsonl file
    inputs:
      setup:
        - cupboard init --data-dir ${tmpdir}/cupboard-data
      command: test -f ${tmpdir}/cupboard-data/links.jsonl
    expected:
      exit_code: 0

  - name: Init creates stashes.jsonl file
    inputs:
      setup:
        - cupboard init --data-dir ${tmpdir}/cupboard-data
      command: test -f ${tmpdir}/cupboard-data/stashes.jsonl
    expected:
      exit_code: 0

  - name: Init creates metadata.jsonl file
    inputs:
      setup:
        - cupboard init --data-dir ${tmpdir}/cupboard-data
      command: test -f ${tmpdir}/cupboard-data/metadata.jsonl
    expected:
      exit_code: 0

  - name: Init is idempotent
    description: >
      Running init twice on the same data directory must succeed without error.
    inputs:
      setup:
        - cupboard init --data-dir ${tmpdir}/cupboard-data
      command: cupboard init --data-dir ${tmpdir}/cupboard-data
    expected:
      exit_code: 0

  # --- S4: set and list round-trip a crumb ---

  - name: Set creates a crumb and returns JSON
    description: >
      The set command creates a crumb with the provided payload. The output
      includes the generated UUID v7 identifier.
    inputs:
      setup:
        - cupboard init --data-dir ${tmpdir}/cupboard-data
      command: cupboard set crumbs "" '{"Name":"Test crumb","State":"draft"}' --data-dir ${tmpdir}/cupboard-data
    expected:
      exit_code: 0
      stdout_contains: "CrumbID"

  - name: List returns the created crumb
    description: >
      After creating a crumb with set, listing crumbs must return it. This
      validates the round-trip through set and list operations.
    inputs:
      setup:
        - cupboard init --data-dir ${tmpdir}/cupboard-data
        - cupboard set crumbs "" '{"Name":"Roundtrip test","State":"draft"}' --data-dir ${tmpdir}/cupboard-data
      command: cupboard list crumbs --data-dir ${tmpdir}/cupboard-data
    expected:
      exit_code: 0
      stdout_contains: "Roundtrip test"

  - name: List with empty table returns empty
    description: >
      Listing crumbs on a freshly initialized cupboard returns an empty list
      without error.
    inputs:
      setup:
        - cupboard init --data-dir ${tmpdir}/cupboard-data
      command: cupboard list crumbs --data-dir ${tmpdir}/cupboard-data
    expected:
      exit_code: 0

  - name: Get retrieves created crumb by ID
    description: >
      After creating a crumb, get retrieves it by the returned ID.
    inputs:
      setup:
        - cupboard init --data-dir ${tmpdir}/cupboard-data
      command: |
        id=$(cupboard set crumbs "" '{"Name":"Get test","State":"draft"}' --data-dir ${tmpdir}/cupboard-data | grep -o '"CrumbID":"[^"]*"' | cut -d'"' -f4)
        cupboard get crumbs "$id" --data-dir ${tmpdir}/cupboard-data
    expected:
      exit_code: 0
      stdout_contains: "Get test"

  - name: Crumb persists across cupboard restarts
    description: >
      A crumb created in one session must persist and be retrievable in a
      subsequent session. This validates JSONL persistence.
    inputs:
      setup:
        - cupboard init --data-dir ${tmpdir}/cupboard-data
        - cupboard set crumbs "" '{"Name":"Persistence test","State":"draft"}' --data-dir ${tmpdir}/cupboard-data
      command: cupboard list crumbs --data-dir ${tmpdir}/cupboard-data
    expected:
      exit_code: 0
      stdout_contains: "Persistence test"

  # --- S5: No manual compilation steps ---

  - name: Version command works without source checkout
    description: >
      The installed binary must work standalone without requiring the source
      repository to be checked out. Running version in any directory succeeds.
    inputs:
      command: cd /tmp && cupboard version
    expected:
      exit_code: 0
      stdout_contains: "cupboard"

  - name: Init works without source checkout
    description: >
      The init command works in any directory without requiring source code.
    inputs:
      command: cd /tmp && cupboard init --data-dir ${tmpdir}/standalone-test
    expected:
      exit_code: 0
      state:
        directory_exists: ${tmpdir}/standalone-test

cleanup:
  - Remove temp directories created during tests
  - Optionally remove cupboard from $GOBIN after tests

id: test-rel02.1-uc003-self-hosting
title: Self-hosting issue-tracking workflow
description: >
  Validates the cupboard CLI as an issue tracker for the crumbs repository.
  Each test case exercises CLI commands via exec, using a fresh cupboard
  instance with JSONL backend. The CLI uses set/get/list commands with JSON
  payloads rather than dedicated issue-tracking subcommands.
traces:
  - rel02.1-uc003-self-hosting
tags:
  - cli
  - integration
  - self-hosting

preconditions:
  - Cupboard binary built from cmd/cupboard
  - Fresh temp directory for config and data
  - No existing crumbs

test_cases:

  # --- initialization ---

  - name: Initialize cupboard
    inputs:
      command: cupboard init
    expected:
      exit_code: 0
      stdout_contains: output message
      state:
        data_directory_exists: true
        crumbs_jsonl_exists: true

  # --- create (set with empty ID) ---

  - name: Create task with required fields
    inputs:
      command: cupboard set crumbs "" '{"Name":"Implement feature","State":"draft"}'
    expected:
      exit_code: 0
      stdout_contains: "CrumbID"

  - name: Create task with JSON output
    inputs:
      command: cupboard set crumbs "" '{"Name":"Write tests","State":"draft"}'
    expected:
      exit_code: 0
      stdout_json:
        Name: "Write tests"
        State: draft
    verify:
      command: cupboard list crumbs
      stdout_contains: '"State": "draft"'

  - name: Create epic with labels
    inputs:
      command: cupboard set crumbs "" '{"Name":"Storage layer","State":"draft"}'
    expected:
      exit_code: 0
      stdout_contains: "CrumbID"

  - name: Create task with parent
    description: >
      Create a parent crumb first, then create a child crumb. Parent-child
      relationships use the links table, not inline JSON fields.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Parent epic","State":"draft"}'
      command: cupboard set crumbs "" '{"Name":"Child task","State":"draft"}'
    expected:
      exit_code: 0
      stdout_contains: "CrumbID"

  - name: Create without name succeeds
    description: >
      Current CLI does not enforce required Name field. Set without Name
      succeeds but creates a crumb with empty Name.
    inputs:
      command: cupboard set crumbs "" '{"State":"draft"}'
    expected:
      exit_code: 0

  - name: Create without state defaults
    inputs:
      command: cupboard set crumbs "" '{"Name":"No state provided"}'
    expected:
      exit_code: 0

  # --- list ---

  - name: List returns all crumbs as JSON
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Task A","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"Task B","State":"draft"}'
      command: cupboard list crumbs
    expected:
      exit_code: 0
      stdout_json:
        length: 2

  - name: List empty cupboard returns empty array
    inputs:
      command: cupboard list crumbs
    expected:
      exit_code: 0
      stdout_json:
        length: 0

  # --- show (get) ---

  - name: Show displays crumb details
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Visible task","State":"draft"}'
      command: cupboard get crumbs ${crumb_id}
    expected:
      exit_code: 0
      stdout_contains: "Visible task"

  - name: Show nonexistent ID fails
    inputs:
      command: cupboard get crumbs nonexistent-id
    expected:
      exit_code: 1

  # --- update (set with existing ID) ---

  - name: Update status to taken (in_progress)
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Claimable","State":"draft"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Updated","State":"taken"}'
    expected:
      exit_code: 0
    verify:
      command: cupboard get crumbs ${crumb_id}
      stdout_contains: "taken"

  - name: Update status to pebble (closed)
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Closeable","State":"draft"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Updated","State":"pebble"}'
    expected:
      exit_code: 0
    verify:
      command: cupboard get crumbs ${crumb_id}
      stdout_contains: "pebble"

  # --- close (set state to pebble) ---

  - name: Close sets state to pebble
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"To close","State":"draft"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Closed","State":"pebble"}'
    expected:
      exit_code: 0
    verify:
      command: cupboard get crumbs ${crumb_id}
      stdout_contains: "pebble"

  - name: Close already-closed crumb succeeds
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Already closed","State":"draft"}'
        - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Already closed","State":"pebble"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Closed","State":"pebble"}'
    expected:
      exit_code: 0
    verify:
      command: cupboard get crumbs ${crumb_id}
      stdout_contains: "pebble"

  # --- ready (list with filter) ---

  - name: Ready returns draft crumbs (open tasks)
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Open task","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"Claimed task","State":"draft"}'
        - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Claimed task","State":"taken"}'
      command: cupboard list crumbs State=draft
    expected:
      exit_code: 0
      stdout_json:
        length: 1

  - name: Ready with no open tasks returns empty
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Only task","State":"draft"}'
        - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Only task","State":"pebble"}'
      command: cupboard list crumbs State=draft
    expected:
      exit_code: 0
      stdout_json:
        length: 0

  # --- end-to-end workflows ---

  - name: Do-work cycle
    description: >
      Simulates the do-work workflow: create task, list ready tasks (draft),
      claim task (set state to taken), close task (set state to pebble).
      Comments are not yet implemented; token tracking step is skipped.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Build widget","State":"draft"}'
      steps:
        - command: cupboard list crumbs State=draft
          verify: length equals 1
        - command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Build widget","State":"taken"}'
        - command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Build widget","State":"pebble"}'
    expected:
      exit_code: 0
    verify:
      command: cupboard get crumbs ${crumb_id}
      stdout_contains: "pebble"

  - name: Make-work cycle
    description: >
      Simulates the make-work workflow: list existing issues, create an epic,
      create child tasks. Parent links use the links table (not tested here).
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Existing task","State":"draft"}'
      steps:
        - command: cupboard list crumbs
          verify: length equals 1
        - command: cupboard set crumbs "" '{"Name":"New epic","State":"draft"}'
        - command: cupboard set crumbs "" '{"Name":"New task 1","State":"draft"}'
        - command: cupboard set crumbs "" '{"Name":"New task 2","State":"draft"}'
    expected:
      exit_code: 0
    verify:
      command: cupboard list crumbs
      stdout_json:
        length: 4

  # --- persistence ---

  - name: JSONL persistence
    description: >
      Validates that crumb data is persisted to crumbs.jsonl file.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Crumb 1","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"Crumb 2","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"Crumb 3","State":"draft"}'
    expected:
      exit_code: 0
      state:
        crumbs_jsonl_count: 3

cleanup:
  - Remove temp config and data directories

id: test-rel01.0-uc003-crumb-lifecycle
title: Crumb entity state machine and archival
description: >
  Validates the crumb state machine (draft→pending→ready→taken→pebble and any→dust),
  timestamp behavior on state transitions, state-based filtering, and crumb archival.
  Covers Crumb entity methods SetState, Pebble, Dust.
traces:
  - rel01.0-uc003-crumb-lifecycle
tags:
  - cli
  - integration
  - state-machine

preconditions:
  - Cupboard binary built from cmd/cupboard
  - Fresh temp directory for config and data
  - Config file points SQLite backend at the temp data directory
  - No existing crumbs

test_cases:

  # --- TestCrumbCreation: S1, S11 ---

  - name: Create crumb with draft state and initialized timestamps
    description: >
      New crumb with explicit draft state has CreatedAt and UpdatedAt set.
      Note: CLI requires explicit State in JSON input.
    inputs:
      command: cupboard set crumbs "" '{"Name":"New crumb","State":"draft"}'
    expected:
      exit_code: 0
      state:
        crumb_id_generated: true
        crumb_state: draft
        created_at_set: true
        updated_at_set: true

  - name: Create crumb with explicit state
    description: >
      Crumb created with explicit ready state is stored with that state.
    inputs:
      command: cupboard set crumbs "" '{"Name":"Ready crumb","State":"ready"}'
    expected:
      exit_code: 0
      state:
        crumb_id_generated: true
        crumb_state: ready
        created_at_set: true
        updated_at_set: true

  # --- TestCrumbStateTransitions: S2, S3, S4, S5 ---

  - name: Transition draft to pending
    description: Create a crumb in draft, then update to pending state.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Test crumb","State":"draft"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Test crumb","State":"pending"}'
      verify: cupboard get crumbs ${crumb_id}
    expected:
      exit_code: 0
      state:
        crumb_state: pending

  - name: Transition pending to ready
    description: Create a crumb in pending, then update to ready state.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Test crumb","State":"pending"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Test crumb","State":"ready"}'
      verify: cupboard get crumbs ${crumb_id}
    expected:
      exit_code: 0
      state:
        crumb_state: ready

  - name: Transition draft to ready
    description: Create a crumb in draft, then update directly to ready state.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Test crumb","State":"draft"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Test crumb","State":"ready"}'
      verify: cupboard get crumbs ${crumb_id}
    expected:
      exit_code: 0
      state:
        crumb_state: ready

  - name: Transition ready to taken
    description: Create a crumb in ready, then update to taken state.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Test crumb","State":"ready"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Test crumb","State":"taken"}'
      verify: cupboard get crumbs ${crumb_id}
    expected:
      exit_code: 0
      state:
        crumb_state: taken

  - name: Transition taken to pebble
    description: Create a crumb in taken, then update to pebble (terminal success).
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Test crumb","State":"taken"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Test crumb","State":"pebble"}'
      verify: cupboard get crumbs ${crumb_id}
    expected:
      exit_code: 0
      state:
        crumb_state: pebble

  # --- TestCrumbDustTransitions: S6, S7 ---

  - name: Transition draft to dust
    description: Move a crumb from draft to terminal dust state.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Dust crumb","State":"draft"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Dust crumb","State":"dust"}'
      verify: cupboard get crumbs ${crumb_id}
    expected:
      exit_code: 0
      state:
        crumb_state: dust

  - name: Transition pending to dust
    description: Verify dust transition works from pending state.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Dust crumb","State":"pending"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Dust crumb","State":"dust"}'
      verify: cupboard get crumbs ${crumb_id}
    expected:
      exit_code: 0
      state:
        crumb_state: dust

  - name: Transition ready to dust
    description: Verify dust transition works from ready state.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Dust crumb","State":"ready"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Dust crumb","State":"dust"}'
      verify: cupboard get crumbs ${crumb_id}
    expected:
      exit_code: 0
      state:
        crumb_state: dust

  - name: Transition taken to dust
    description: Verify dust transition works from taken state.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Dust crumb","State":"taken"}'
      command: cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Dust crumb","State":"dust"}'
      verify: cupboard get crumbs ${crumb_id}
    expected:
      exit_code: 0
      state:
        crumb_state: dust

  # --- TestCrumbTimestampTracking: S8 ---

  - name: UpdatedAt advances on state transition
    description: >
      Verify UpdatedAt changes when state transitions and is later than previous value.
      CreatedAt must remain constant.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Timestamp crumb","State":"draft"}'
      steps:
        - record original_updated_at from crumb
        - sleep 1100ms to ensure timestamp difference
        - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Timestamp crumb","State":"ready"}'
    expected:
      exit_code: 0
      state:
        crumb_state: ready
        updated_at_advanced: true
        updated_at_after_original: true

  # --- TestCrumbFetchByState: S9, S10 ---

  - name: Fetch by single state returns matching crumbs only
    description: Listing by a specific state returns only crumbs in that state.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Draft crumb","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"Ready crumb","State":"ready"}'
        - cupboard set crumbs "" '{"Name":"Taken crumb","State":"taken"}'
      command: cupboard list crumbs State=ready
    expected:
      exit_code: 0
      state:
        result_count: 1
        contains_name: "Ready crumb"
        excludes_names:
          - "Draft crumb"
          - "Taken crumb"

  - name: Filter excludes pebble crumbs from non-terminal state list
    description: Listing by state=draft excludes pebble crumbs.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Draft crumb","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"Pebble crumb","State":"pebble"}'
      command: cupboard list crumbs State=draft
    expected:
      exit_code: 0
      state:
        result_count: 1
        contains_name: "Draft crumb"
        excludes_names:
          - "Pebble crumb"

  - name: Filter excludes dust crumbs from non-terminal state list
    description: Listing by state=draft excludes dust crumbs.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Draft crumb","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"Dust crumb","State":"dust"}'
      command: cupboard list crumbs State=draft
    expected:
      exit_code: 0
      state:
        result_count: 1
        contains_name: "Draft crumb"
        excludes_names:
          - "Dust crumb"

  - name: Filter for pebble state returns only pebble crumbs
    description: Listing by state=pebble returns only completed crumbs.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Draft crumb","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"Pebble crumb","State":"pebble"}'
        - cupboard set crumbs "" '{"Name":"Dust crumb","State":"dust"}'
      command: cupboard list crumbs State=pebble
    expected:
      exit_code: 0
      state:
        result_count: 1
        contains_name: "Pebble crumb"
        excludes_names:
          - "Draft crumb"
          - "Dust crumb"

  - name: Filter for dust state returns only dust crumbs
    description: Listing by state=dust returns only archived crumbs.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Draft crumb","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"Pebble crumb","State":"pebble"}'
        - cupboard set crumbs "" '{"Name":"Dust crumb","State":"dust"}'
      command: cupboard list crumbs State=dust
    expected:
      exit_code: 0
      state:
        result_count: 1
        contains_name: "Dust crumb"
        excludes_names:
          - "Draft crumb"
          - "Pebble crumb"

  # --- TestCrumbFetchAllStates ---

  - name: List without filter returns all crumbs
    description: Listing crumbs without state filter returns all crumbs regardless of state.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Draft crumb","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"Ready crumb","State":"ready"}'
        - cupboard set crumbs "" '{"Name":"Taken crumb","State":"taken"}'
      command: cupboard list crumbs
    expected:
      exit_code: 0
      state:
        result_count: 3
        contains_names:
          - "Draft crumb"
          - "Ready crumb"
          - "Taken crumb"

  # --- TestFullSuccessPath ---

  - name: Full success path draft to pebble
    description: >
      Exercise the complete success path: draft → pending → ready → taken → pebble.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Success path crumb","State":"draft"}'
      steps:
        - verify initial state is draft
        - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Success path crumb","State":"pending"}'
        - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Success path crumb","State":"ready"}'
        - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Success path crumb","State":"taken"}'
        - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Success path crumb","State":"pebble"}'
      verify: cupboard get crumbs ${crumb_id}
    expected:
      exit_code: 0
      state:
        crumb_state: pebble

  # --- TestFullFailurePath ---

  - name: Full failure path draft to dust
    description: >
      Exercise the failure path: draft → dust.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Failure path crumb","State":"draft"}'
      steps:
        - verify initial state is draft
        - cupboard set crumbs ${crumb_id} '{"CrumbID":"${crumb_id}","Name":"Failure path crumb","State":"dust"}'
      verify: cupboard get crumbs ${crumb_id}
    expected:
      exit_code: 0
      state:
        crumb_state: dust

  # --- TestMixedTerminalStates ---

  - name: Mixed terminal states in same table
    description: >
      Create multiple crumbs with different terminal states and verify correct filtering.
    inputs:
      setup:
        - cupboard set crumbs "" '{"Name":"Draft crumb","State":"draft"}'
        - cupboard set crumbs "" '{"Name":"Pebble crumb","State":"pebble"}'
        - cupboard set crumbs "" '{"Name":"Dust crumb","State":"dust"}'
    expected:
      exit_code: 0
      state:
        total_crumb_count: 3
        draft_count: 1
        pebble_count: 1
        dust_count: 1

cleanup:
  - Remove temp config and data directories

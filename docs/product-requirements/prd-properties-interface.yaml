id: prd-properties-interface
title: Properties Interface
problem: |
  Applications need extensible attributes on crumbs beyond the core fields (name, state, timestamps). A task tracker might need priority, labels, and owner; a bug tracker might need severity and component. Hardcoding these fields into the Crumb struct creates rigid schemas that require code changes and migrations for every new attribute.

  We need a property system where applications can define custom attributes at runtime. Properties are metadata definitions (name, type, description) that can then be assigned values on individual crumbs. This separates schema (what properties exist) from data (what values crumbs have), enabling flexibility without migrations.

  This PRD defines the Property and Category entities: their struct fields and entity methods. Properties and categories are stored and retrieved via the generic Table interface from prd-cupboard-core. Setting and getting property values on crumbs is handled by Crumb entity methods (see prd-crumbs-interface); this PRD covers only the property definitions themselves.

  Future scope: VISION.md establishes that properties are a general mechanism extending crumbs, trails, and stashes uniformly. This PRD specifies crumb properties for the current release. Trail properties (e.g., hypothesis, approach, risk-level for exploration sessions) and stash properties (e.g., build-stage, artifact-type, retention-policy for shared state) will follow the same pattern in later releases.
goals:
  - G1: Define the Property struct with all required fields
  - G2: Define the Category struct for categorical properties
  - G3: Define value types and their meaning
  - G4: Specify entity method DefineCategory for creating categories on a property
  - G5: Specify how properties are created, retrieved, and queried via the Table interface
  - G6: Document built-in properties seeded on first startup
  - G7: Document error conditions for all operations
requirements:
  R1:
    title: Property Struct
    items:
      - R1.1: The Property struct must include the following fields
        detail: |
          | Field | Type | Description |
          |-------|------|-------------|
          | PropertyID | string | UUID v7, generated on creation |
          | Name | string | Unique human-readable name (e.g., "priority", "labels") |
          | Description | string | Optional explanation of the property's purpose |
          | ValueType | string | Type of values this property accepts (see R3) |
          | CreatedAt | time.Time | Timestamp of creation |
      - R1.2: PropertyID must be a UUID v7 (time-ordered) generated by the backend when Table.Set is called with an empty id parameter
      - R1.3: Name must be unique across all properties. Table.Set must reject duplicate names with ErrDuplicateName
      - R1.4: Name must be non-empty. Table.Set must reject empty names with ErrInvalidName
      - R1.5: Description may be empty
  R2:
    title: Category Struct
    items:
      - R2.1: The Category struct must include the following fields
        detail: |
          | Field | Type | Description |
          |-------|------|-------------|
          | CategoryID | string | UUID v7, generated on creation |
          | PropertyID | string | The categorical property this category belongs to |
          | Name | string | Display name for this category (e.g., "high", "medium") |
          | Ordinal | int | Sort order; lower ordinals sort first |
      - R2.2: CategoryID must be a UUID v7 (time-ordered) generated by the backend when Table.Set is called with an empty id parameter
      - R2.3: Categories enable ordered enumeration for categorical properties. When a crumb has a categorical property value, the value is a CategoryID
      - R2.4: Name must be unique within a property. Table.Set must reject duplicate names for the same property with ErrDuplicateName
      - R2.5: Ordinal determines display order. Categories with lower ordinals appear first. Multiple categories may share the same ordinal (ties broken by name)
  R3:
    title: Value Types
    items:
      - R3.1: A property must have exactly one of the following value types
        detail: |
          | ValueType | Go Type | JSON Type | Description |
          |-----------|---------|-----------|-------------|
          | categorical | string | string | CategoryID from the property's categories |
          | text | string | string | Free-form text |
          | integer | int64 | number | Whole number |
          | boolean | bool | boolean | True or false |
          | timestamp | time.Time | string | RFC 3339 timestamp |
          | list | []string | array | List of strings (e.g., labels, tags) |
      - R3.2: ValueType is stored as a string, not an enum, for JSON compatibility
      - R3.3: Crumb.SetProperty validates that values match the property's ValueType (see prd-crumbs-interface R5)
      - R3.4: For categorical properties, values must be valid CategoryIDs defined for that property
      - R3.5: Each value type has a default value used when initializing properties on crumbs
        detail: |
          | ValueType | Default Value | Description |
          |-----------|---------------|-------------|
          | categorical | null | No category selected; first category by ordinal if categories exist |
          | text | "" | Empty string |
          | integer | 0 | Zero |
          | boolean | false | False |
          | timestamp | null | No timestamp set |
          | list | [] | Empty list |
      - R3.6: Default values ensure every crumb has a value for every defined property. There is no concept of a property being "not set" on a crumb
  R4:
    title: Creating Properties
    items:
      - R4.1: To create a new property, the caller constructs a Property struct and passes it to Table.Set
        detail: |
          ```go
          prop := &Property{
              Name:        "priority",
              Description: "Task priority level",
              ValueType:   "categorical",
          }
          id, err := table.Set("", prop)
          ```
      - R4.2: When Table.Set is called with an empty id parameter, the backend must generate a UUID v7 for PropertyID, set CreatedAt to the current time, validate that Name is non-empty (ErrInvalidName if empty), validate that Name is unique (ErrDuplicateName if exists), validate that ValueType is one of the valid types in R3.1 (ErrInvalidValueType if not), and initialize the property on all existing crumbs with the type's default value (see R3.5)
      - R4.3: Property initialization on existing crumbs (backfill) is atomic with property creation. If backfill fails, the property is not created
      - R4.4: Table.Set returns the generated PropertyID and any error. After successful creation, the Property struct is updated with the generated PropertyID and CreatedAt timestamp
      - R4.5: Table.Set must persist the property before returning
  R5:
    title: Retrieving Properties
    items:
      - R5.1: To retrieve a property by ID, use Table.Get
        detail: |
          ```go
          entity, err := table.Get(id)
          if err != nil {
              // handle error
          }
          prop := entity.(*Property)
          ```
      - R5.2: Table.Get returns the entity as any; the caller must type-assert to *Property
      - R5.3: Table.Get returns ErrNotFound if no property exists with the given ID
      - R5.4: Table.Get returns ErrInvalidID if id is empty
  R6:
    title: Querying Properties
    items:
      - R6.1: To retrieve all properties, use Table.Fetch with an empty filter
        detail: |
          ```go
          entities, err := table.Fetch(nil)
          props := make([]*Property, len(entities))
          for i, entity := range entities {
              props[i] = entity.(*Property)
          }
          ```
      - R6.2: Table.Fetch returns a slice of entities ([]any); the caller must type-assert each element to *Property
      - R6.3: Table.Fetch returns an empty slice (not nil) if no properties exist
      - R6.4: Results are ordered by CreatedAt ascending (oldest first, built-ins first)
  R7:
    title: DefineCategory Entity Method
    items:
      - R7.1: DefineCategory is an entity method on Property that creates a new category
        detail: |
          ```go
          func (p *Property) DefineCategory(cupboard Cupboard, name string, ordinal int) (*Category, error)
          ```
      - R7.2: DefineCategory must validate that the property's ValueType is "categorical" (ErrInvalidValueType if not)
      - R7.3: DefineCategory must validate that name is non-empty (ErrInvalidName if empty)
      - R7.4: DefineCategory must validate that name is unique within the property (ErrDuplicateName if exists)
      - R7.5: DefineCategory must create a Category struct with a UUID v7 for CategoryID (generated by the backend), PropertyID set to the property's ID, and the provided name and ordinal
      - R7.6: DefineCategory must persist the category to backend storage. The backend manages category storage internally (e.g., SQLite backend uses categories.jsonl)
      - R7.7: DefineCategory must return the created Category with all fields populated
      - R7.8: Ordinal may be any integer. Negative ordinals are allowed
      - R7.9: DefineCategory requires the Cupboard reference to access backend storage for categories
  R8:
    title: GetCategories Entity Method
    items:
      - R8.1: GetCategories is an entity method on Property that retrieves all categories for the property
        detail: |
          ```go
          func (p *Property) GetCategories(cupboard Cupboard) ([]*Category, error)
          ```
      - R8.2: GetCategories must validate that the property's ValueType is "categorical" (ErrInvalidValueType if not)
      - R8.3: GetCategories must query backend storage for categories with a filter for PropertyID
      - R8.4: GetCategories must return categories ordered by ordinal ascending, then name ascending for ties
      - R8.5: GetCategories must return an empty slice (not nil) if no categories are defined for the property
      - R8.6: GetCategories requires the Cupboard reference to access backend storage for categories
  R9:
    title: Built-in Properties
    items:
      - R9.1: On first startup (when properties storage is empty), the backend must seed the following built-in properties
        detail: |
          | Name | ValueType | Description |
          |------|-----------|-------------|
          | priority | categorical | Task priority level |
          | type | categorical | Crumb type classification |
          | description | text | Detailed description |
          | owner | text | Assigned worker or user ID |
          | labels | list | Capability tags or labels |

          Note: Crumb dependencies use `child_of` links (see prd-sqlite-backend), not a property.
      - R9.2: Built-in categories for "priority" property
        detail: |
          | Name | Ordinal |
          |------|---------|
          | highest | 0 |
          | high | 1 |
          | medium | 2 |
          | low | 3 |
          | lowest | 4 |
      - R9.3: Built-in categories for "type" property
        detail: |
          | Name | Ordinal |
          |------|---------|
          | task | 0 |
          | epic | 1 |
          | bug | 2 |
          | chore | 3 |
      - R9.4: Seeding only occurs when the properties storage is empty (first run). Existing data is never modified by seeding
      - R9.5: Built-in properties can be extended (new categories added) but not deleted or renamed
      - R9.6: Applications may define additional properties beyond the built-ins
  R10:
    title: Error Types
    items:
      - R10.1: Property and Category operations must return the following sentinel errors
        detail: |
          | Error | When |
          |-------|------|
          | ErrNotFound | Property or category ID does not exist |
          | ErrInvalidID | ID is empty |
          | ErrInvalidName | Name is empty |
          | ErrDuplicateName | Name already exists (property or category within property) |
          | ErrInvalidValueType | ValueType is not recognized or operation invalid for type |
          | ErrCupboardDetached | Cupboard has been detached |
      - R10.2: All errors must be checkable with errors.Is
non_goals:
  - This PRD does not define setting or getting property values on crumbs. See prd-crumbs-interface for SetProperty, GetProperty, GetProperties, and ClearProperty
  - This PRD does not define property deletion. Properties are permanent once defined. Applications can stop using a property but cannot remove its definition
  - This PRD does not define property modification (renaming, changing type). Properties are immutable after creation
  - This PRD does not define property inheritance or computed properties
  - This PRD does not define validation rules beyond type checking (e.g., regex patterns, min/max values)
  - This PRD does not define a specialized PropertyTable interface. Properties and categories are accessed via the standard Table interface from prd-cupboard-core
acceptance_criteria:
  - Property struct defined with PropertyID, Name, Description, ValueType, CreatedAt
  - Category struct defined with CategoryID, PropertyID, Name, Ordinal
  - Value types documented (categorical, text, integer, boolean, timestamp, list)
  - Default values documented for each value type (R3.5)
  - Property creation via Table.Set specified (ID generation, validation, backfill existing crumbs)
  - Property retrieval via Table.Get specified (type assertion to *Property)
  - Property query via Table.Fetch specified (list all properties)
  - DefineCategory entity method specified (create category, validation, persist via Table.Set)
  - GetCategories entity method specified (retrieve categories for a property)
  - Built-in properties listed (priority, type, description, owner, labels)
  - Built-in categories listed for priority and type
  - Error types documented
  - All requirements numbered and specific
constraints:
  - PropertyID and CategoryID use UUID v7 for time-ordering and uniqueness
  - ValueType is a string for JSON serialization (not a Go enum)
  - All timestamps use time.Time (RFC 3339 in JSON)
  - Property names must be unique across the entire cupboard
  - Category names must be unique within their property
  - Properties and categories are immutable after creation
references:
  - prd-cupboard-core (Cupboard interface, Table interface, standard table names)
  - prd-sqlite-backend (JSON format, SQLite schema, built-in property seeding)
  - prd-crumbs-interface (SetProperty, GetProperty, GetProperties, ClearProperty)

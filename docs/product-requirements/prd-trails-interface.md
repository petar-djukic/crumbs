# PRD: Trails Interface

## Problem

Applications need to support exploratory work sessions where users can try different approaches without committing to them permanently. A developer might start working on a feature, explore multiple implementation paths, and later decide to keep some work while discarding dead ends. Without trails, all crumbs are permanent from the moment of creation, making exploratory workflows awkward or impossible.

We need a way to group crumbs into exploratory sessions (trails) that can later be committed (made permanent) or abandoned (discarded entirely). This enables backtracking and branching without cluttering the main work stream with abandoned attempts.

This PRD defines the Trail entity: its struct fields, entity methods for lifecycle operations (Complete, Abandon), and entity methods for managing crumb associations (AddCrumb, RemoveCrumb, GetCrumbs). Trail membership is stored via the links table (belongs_to relationship); this PRD specifies the semantics while prd-sqlite-backend specifies the storage.

## Goals

1. Define the Trail struct with all required fields
2. Define trail states and their meaning
3. Specify entity methods for lifecycle operations (Complete, Abandon)
4. Specify entity methods for crumb association (AddCrumb, RemoveCrumb, GetCrumbs)
5. Specify Complete method semantics (crumbs become permanent)
6. Specify Abandon method semantics (crumbs are deleted)
7. Document error conditions for all entity methods
8. Define how trails are accessed via the Table interface

## Requirements

### R1: Trail Struct

1.1. The Trail struct must include these fields:

| Field | Type | Description |
|-------|------|-------------|
| TrailID | string | UUID v7, generated on creation |
| ParentCrumbID | *string | Optional crumb ID this trail deviates from; nil if standalone |
| State | string | Trail state (see R2) |
| CreatedAt | time.Time | Timestamp of creation |
| CompletedAt | *time.Time | Timestamp when completed or abandoned; nil if active |

1.2. TrailID must be a UUID v7 (time-ordered) generated by the backend when Set is called with an empty ID.

1.3. ParentCrumbID links the trail to an existing crumb, allowing branching from a specific point in the work graph. When set, the trail represents an alternative approach starting from that crumb.

1.4. CompletedAt is set when the trail transitions to completed or abandoned state.

### R2: State Values

2.1. A trail must be in exactly one of these states:

| State | Description |
|-------|-------------|
| active | Trail is open for work; crumbs can be added |
| completed | Trail is finished; crumbs have been made permanent |
| abandoned | Trail is discarded; crumbs have been deleted |

2.2. Initial state on creation is active.

2.3. State transitions are one-way: active can transition to completed or abandoned, but completed and abandoned are terminal states.

2.4. State is stored as a string, not an enum, for JSON compatibility.

### R3: Trail Creation

3.1. Trails are created via the Table interface (Cupboard.GetTable("trails").Set):

```go
trail := &Trail{
    ParentCrumbID: nil,  // or pointer to crumb ID
    State:         "active",
    CreatedAt:     time.Now(),
}
err := trailsTable.Set("", trail)  // empty ID triggers generation
```

3.2. The backend must generate a UUID v7 for TrailID when Set is called with an empty ID.

3.3. Initial State must be "active", CreatedAt must be set to the current time, and CompletedAt must be nil.

3.4. If ParentCrumbID is provided, the backend should validate that the crumb exists (returning ErrNotFound if not).

3.5. After Set returns, the Trail struct must have TrailID populated by the backend.

### R4: Trail Retrieval

4.1. Trails are retrieved via the Table interface:

```go
trailsTable := cupboard.GetTable("trails")
obj, err := trailsTable.Get(trailID)
trail := obj.(*Trail)  // type assertion
```

4.2. Get must return the Trail entity if found.

4.3. Get must return ErrNotFound if no trail exists with the given ID.

4.4. Get must return ErrInvalidID if id is empty.

### R5: GetCrumbs Entity Method

5.1. GetCrumbs is an entity method on Trail that lists all crumbs belonging to the trail:

```go
func (t *Trail) GetCrumbs(cupboard Cupboard) ([]*Crumb, error)
```

5.2. GetCrumbs queries the links table for belongs_to links where to_id equals the trail ID.

5.3. GetCrumbs must return an empty slice (not nil) if the trail has no crumbs.

5.4. Results are ordered by crumb CreatedAt ascending (oldest first, preserving creation order).

5.5. GetCrumbs returns the full Crumb objects, not just IDs.

5.6. GetCrumbs requires the Cupboard reference to access the links and crumbs tables.

### R6: Complete Entity Method

6.1. Complete is an entity method on Trail that marks it as finished and makes its crumbs permanent:

```go
func (t *Trail) Complete(cupboard Cupboard) error
```

6.2. Complete must set the trail's State field to "completed".

6.3. Complete must set the CompletedAt field to the current time.

6.4. Complete must remove all belongs_to links for crumbs on this trail. After completion, the crumbs exist but do not belong to any trail.

6.5. Complete must return ErrInvalidState if the trail is not in "active" state.

6.6. Complete must persist the updated Trail via cupboard.GetTable("trails").Set(t.TrailID, t).

6.7. Complete must be atomic: all changes succeed or none do.

6.8. After Complete, the crumbs are indistinguishable from crumbs that were never on a trail. They have become permanent parts of the work graph.

6.9. Complete requires the Cupboard reference to access the links and trails tables.

### R7: Abandon Entity Method

7.1. Abandon is an entity method on Trail that discards it and deletes all its crumbs:

```go
func (t *Trail) Abandon(cupboard Cupboard) error
```

7.2. Abandon must set the trail's State field to "abandoned".

7.3. Abandon must set the CompletedAt field to the current time.

7.4. Abandon must delete all crumbs that belong to this trail (via belongs_to links).

7.5. For each deleted crumb, Abandon must also delete:

- All property values for the crumb (crumb_properties)
- All metadata for the crumb
- All links where the crumb is from_id or to_id (belongs_to, child_of)

7.6. Abandon must return ErrInvalidState if the trail is not in "active" state.

7.7. Abandon must persist the updated Trail via cupboard.GetTable("trails").Set(t.TrailID, t).

7.8. Abandon must be atomic: all deletions succeed or none do.

7.9. After Abandon, the trail remains in the database (for audit purposes) but has no associated crumbs.

7.10. Abandon requires the Cupboard reference to access the links, crumbs, and trails tables.

### R8: Crumb Membership

8.1. A crumb belongs to a trail via a belongs_to link in the links table:

| Field | Value |
|-------|-------|
| link_type | "belongs_to" |
| from_id | crumb_id |
| to_id | trail_id |

8.2. A crumb can belong to at most one trail at a time. The backend must enforce this constraint.

8.3. Crumbs not on any trail (no belongs_to link) are considered permanent or "untracked."

8.4. The Table interface provides low-level link operations via the links table. Trail entity methods AddCrumb and RemoveCrumb (R10, R11) provide higher-level operations for managing membership.

8.5. Moving a crumb between trails requires removing from the old trail and adding to the new one.

### R9: Error Types

9.1. Trail entity methods must return these sentinel errors:

| Error | When |
|-------|------|
| ErrNotFound | Trail or crumb ID does not exist |
| ErrInvalidID | Trail ID is empty |
| ErrInvalidState | Operation not valid for current trail state |
| ErrAlreadyInTrail | Crumb already belongs to another trail |
| ErrNotInTrail | Crumb does not belong to the specified trail |
| ErrCupboardClosed | Cupboard has been closed |

9.2. All errors must be checkable with errors.Is.

9.3. ErrInvalidState should include the current state and expected state in the error message for debugging.

### R10: AddCrumb Entity Method

10.1. AddCrumb is an entity method on Trail that adds a crumb to the trail:

```go
func (t *Trail) AddCrumb(cupboard Cupboard, crumbID string) error
```

10.2. AddCrumb must validate that the crumb exists (ErrNotFound if not).

10.3. AddCrumb must validate that the trail is in "active" state (ErrInvalidState if not).

10.4. AddCrumb must validate that the crumb does not already belong to another trail (ErrAlreadyInTrail if it does).

10.5. AddCrumb must create a belongs_to link from the crumb to the trail via the links table.

10.6. AddCrumb must return ErrInvalidID if crumbID is empty.

10.7. AddCrumb is idempotent: adding a crumb that already belongs to this trail succeeds without error.

10.8. AddCrumb requires the Cupboard reference to access the links and crumbs tables.

### R11: RemoveCrumb Entity Method

11.1. RemoveCrumb is an entity method on Trail that removes a crumb from the trail:

```go
func (t *Trail) RemoveCrumb(cupboard Cupboard, crumbID string) error
```

11.2. RemoveCrumb must validate that the crumb exists (ErrNotFound if not).

11.3. RemoveCrumb must validate that the trail is in "active" state (ErrInvalidState if not).

11.4. RemoveCrumb must remove the belongs_to link from the crumb to the trail via the links table.

11.5. RemoveCrumb must return ErrInvalidID if crumbID is empty.

11.6. RemoveCrumb is idempotent: removing a crumb that does not belong to this trail succeeds without error.

11.7. After RemoveCrumb, the crumb still exists but is no longer associated with any trail (becomes permanent).

11.8. RemoveCrumb requires the Cupboard reference to access the links and crumbs tables.

## Non-Goals

1. This PRD does not define crumb CRUD operations. See prd-crumbs-interface.

2. This PRD does not define the Table interface or link storage. The Table interface is defined in prd-cupboard-core and the links table is detailed in prd-sqlite-backend. This PRD defines entity methods that use those interfaces.

3. This PRD does not define nested trails or trail hierarchies. Each trail is independent.

4. This PRD does not define undo for Complete or Abandon. These are terminal operations.

5. This PRD does not define batch operations on trails (e.g., merge trails, split trails).

6. This PRD does not define a specialized TrailTable interface. Trails are accessed via the standard Table interface from prd-cupboard-core.

## Acceptance Criteria

- [ ] Trail struct defined with TrailID, ParentCrumbID, State, CreatedAt, CompletedAt
- [ ] State values documented (active, completed, abandoned)
- [ ] Trail creation specified via Table.Set interface
- [ ] Trail retrieval specified via Table.Get interface
- [ ] GetCrumbs entity method specified (list crumbs via belongs_to links)
- [ ] Complete entity method specified (mark completed, remove belongs_to links)
- [ ] Abandon entity method specified (mark abandoned, delete crumbs and links)
- [ ] Crumb membership semantics documented (belongs_to link, one trail per crumb)
- [ ] AddCrumb entity method specified (add crumb to trail, validation)
- [ ] RemoveCrumb entity method specified (remove crumb from trail, idempotent)
- [ ] Error types documented (including ErrAlreadyInTrail, ErrNotInTrail)
- [ ] All entity methods accept Cupboard parameter for table access
- [ ] All requirements numbered and specific
- [ ] File saved at docs/product-requirements/prd-trails-interface.md

## Constraints

- TrailID uses UUID v7 for time-ordering and uniqueness
- State is a string for JSON serialization (not a Go enum)
- All timestamps use time.Time (RFC 3339 in JSON)
- Crumb membership is stored in the links table, not on the Trail struct
- Complete and Abandon are terminal; there is no way to revert

## References

- prd-cupboard-core (Cupboard interface, Table interface, standard table names)
- prd-sqlite-backend (JSON format, SQLite schema, links table, graph model)
- prd-crumbs-interface (Crumb struct, crumb operations)

# PRD: Trails Interface

## Problem

Applications need to support exploratory work sessions where users can try different approaches without committing to them permanently. A developer might start working on a feature, explore multiple implementation paths, and later decide to keep some work while discarding dead ends. Without trails, all crumbs are permanent from the moment of creation, making exploratory workflows awkward or impossible.

We need a way to group crumbs into exploratory sessions (trails) that can later be committed (made permanent) or abandoned (discarded entirely). This enables backtracking and branching without cluttering the main work stream with abandoned attempts.

This PRD defines the Trail entity: its struct fields and entity methods for lifecycle operations (Complete, Abandon). Entity methods update the Trail struct in memory; the caller persists changes via Table.Set, at which point the backend performs cascade operations (removing links or deleting crumbs). Trail membership is stored via the links table (belongs_to relationship); this PRD specifies the semantics while prd-sqlite-backend specifies the storage.

## Goals

1. Define the Trail struct with all required fields
2. Define trail states and their meaning
3. Specify entity methods for lifecycle operations (Complete, Abandon)
4. Specify Complete method semantics (entity updates state; backend cascades on persist)
5. Specify Abandon method semantics (entity updates state; backend cascades on persist)
6. Document error conditions for entity methods
7. Define how trails are accessed via the Table interface

## Requirements

### R1: Trail Struct

1.1. The Trail struct must include these fields:

| Field | Type | Description |
|-------|------|-------------|
| TrailID | string | UUID v7, generated on creation |
| State | string | Trail state (see R2) |
| CreatedAt | time.Time | Timestamp of creation |
| CompletedAt | *time.Time | Timestamp when completed or abandoned; nil if active |

1.2. TrailID must be a UUID v7 (time-ordered) generated by the backend when Set is called with an empty ID.

1.3. CompletedAt is set when the trail transitions to completed or abandoned state.

1.4. Trail branching (deviating from a crumb on another trail) uses a `branches_from` link in the links table (see R9).

### R2: State Values

2.1. A trail must be in exactly one of these states:

| State | Description |
|-------|-------------|
| active | Trail is open for work; crumbs can be added |
| completed | Trail is finished; crumbs have been made permanent |
| abandoned | Trail is discarded; crumbs have been deleted |

2.2. Initial state on creation is active.

2.3. State transitions are one-way: active can transition to completed or abandoned, but completed and abandoned are terminal states.

2.4. State is stored as a string, not an enum, for JSON compatibility.

### R3: Trail Creation

3.1. Trails are created via the Table interface (Cupboard.GetTable("trails").Set):

```go
trail := &Trail{
    State:     "active",
    CreatedAt: time.Now(),
}
id, err := trailsTable.Set("", trail)  // empty ID triggers generation
```

3.2. The backend must generate a UUID v7 for TrailID when Set is called with an empty ID.

3.3. Initial State must be "active", CreatedAt must be set to the current time, and CompletedAt must be nil.

3.4. After Set returns, the Trail struct must have TrailID populated by the backend.

3.5. To create a trail that branches from a crumb, first create the trail, then create a `branches_from` link (see R9).

### R4: Trail Retrieval

4.1. Trails are retrieved via the Table interface:

```go
trailsTable, _ := cupboard.GetTable("trails")
obj, err := trailsTable.Get(trailID)
trail := obj.(*Trail)  // type assertion
```

4.2. Get must return the Trail entity if found.

4.3. Get must return ErrNotFound if no trail exists with the given ID.

4.4. Get must return ErrInvalidID if id is empty.

### R5: Complete Entity Method

5.1. Complete is an entity method on Trail that marks it as finished:

```go
func (t *Trail) Complete() error
```

5.2. Complete must set the trail's State field to "completed".

5.3. Complete must set the CompletedAt field to the current time.

5.4. Complete must return ErrInvalidState if the trail is not in "active" state.

5.5. Complete only updates the Trail struct in memory. The caller must persist changes via Table.Set.

5.6. When the trail is persisted via Table.Set, the backend removes all belongs_to links for crumbs on this trail. After persistence, the crumbs exist but do not belong to any trail.

5.7. The backend must perform the cascade operation atomically with the trail update.

5.8. After completion and persistence, the crumbs are indistinguishable from crumbs that were never on a trail. They have become permanent parts of the work graph.

### R6: Abandon Entity Method

6.1. Abandon is an entity method on Trail that marks it as discarded:

```go
func (t *Trail) Abandon() error
```

6.2. Abandon must set the trail's State field to "abandoned".

6.3. Abandon must set the CompletedAt field to the current time.

6.4. Abandon must return ErrInvalidState if the trail is not in "active" state.

6.5. Abandon only updates the Trail struct in memory. The caller must persist changes via Table.Set.

6.6. When the trail is persisted via Table.Set, the backend deletes all crumbs that belong to this trail (via belongs_to links).

6.7. For each deleted crumb, the backend must also delete:

- All property values for the crumb (crumb_properties)
- All metadata for the crumb
- All links where the crumb is from_id or to_id (belongs_to, child_of)

6.8. The backend must perform all cascade deletions atomically with the trail update.

6.9. After abandonment and persistence, the trail remains in the database (for audit purposes) but has no associated crumbs.

### R7: Crumb Membership

7.1. A crumb belongs to a trail via a belongs_to link in the links table:

| Field | Value |
|-------|-------|
| link_type | "belongs_to" |
| from_id | crumb_id |
| to_id | trail_id |

7.2. A crumb can belong to at most one trail at a time. The backend must enforce this constraint.

7.3. Crumbs not on any trail (no belongs_to link) are considered permanent or "untracked."

7.4. Crumb-to-trail membership is managed via the links table. Applications create belongs_to links using the Table interface for the links table.

7.5. Moving a crumb between trails requires removing the old belongs_to link and creating a new one.

### R8: Error Types

8.1. Trail entity methods must return these sentinel errors:

| Error | When |
|-------|------|
| ErrInvalidState | Operation not valid for current trail state |

8.2. All errors must be checkable with errors.Is.

8.3. Table operations (Get, Set, Fetch) may return additional errors as defined in prd-cupboard-core R7:

| Error | When |
|-------|------|
| ErrNotFound | Trail ID does not exist |
| ErrInvalidID | Trail ID is empty |
| ErrCupboardDetached | Cupboard has been detached |

### R9: Trail Branching

9.1. A trail can branch from a crumb via a `branches_from` link in the links table:

| Field | Value |
|-------|-------|
| link_type | "branches_from" |
| from_id | trail_id |
| to_id | crumb_id |

9.2. A trail can have at most one `branches_from` link. The backend must enforce this constraint.

9.3. The `branches_from` link indicates that this trail represents an alternative approach starting from a specific crumb in the work graph.

9.4. Trail branching is managed via the links table. Applications create `branches_from` links using the Table interface for the links table:

```go
link := &Link{
    LinkType: "branches_from",
    FromID:   trail.TrailID,
    ToID:     parentCrumbID,
}
linksTable.Set("", link)
```

9.5. To find the branch point of a trail, query the links table for a `branches_from` link where `from_id` equals the trail ID.

9.6. Trails without a `branches_from` link are standalone (not branched from any crumb).

## Non-Goals

1. This PRD does not define crumb CRUD operations. See prd-crumbs-interface.

2. This PRD does not define the Table interface or link storage. The Table interface is defined in prd-cupboard-core and the links table is detailed in prd-sqlite-backend. This PRD defines entity methods that use those interfaces.

3. This PRD does not define nested trails or trail hierarchies. Each trail is independent.

4. This PRD does not define undo for Complete or Abandon. These are terminal operations.

5. This PRD does not define batch operations on trails (e.g., merge trails, split trails).

6. This PRD does not define a specialized TrailTable interface. Trails are accessed via the standard Table interface from prd-cupboard-core.

7. This PRD does not define entity methods for adding or removing crumbs from trails. Crumb membership is managed via the links table using the standard Table interface.

## Acceptance Criteria

- [ ] Trail struct defined with TrailID, State, CreatedAt, CompletedAt
- [ ] State values documented (active, completed, abandoned)
- [ ] Trail creation specified via Table.Set interface
- [ ] Trail retrieval specified via Table.Get interface
- [ ] Complete entity method specified with no arguments (updates State and CompletedAt)
- [ ] Complete documents backend cascade responsibility (remove belongs_to links on Table.Set)
- [ ] Abandon entity method specified with no arguments (updates State and CompletedAt)
- [ ] Abandon documents backend cascade responsibility (delete crumbs on Table.Set)
- [ ] Crumb membership semantics documented (belongs_to link, one trail per crumb)
- [ ] Trail branching semantics documented (branches_from link, one per trail)
- [ ] Error types documented (ErrInvalidState for entity methods)
- [ ] All requirements numbered and specific
- [ ] File saved at docs/product-requirements/prd-trails-interface.md

## Constraints

- TrailID uses UUID v7 for time-ordering and uniqueness
- State is a string for JSON serialization (not a Go enum)
- All timestamps use time.Time (RFC 3339 in JSON)
- Crumb membership is stored in the links table, not on the Trail struct
- Complete and Abandon are terminal; there is no way to revert

## References

- prd-cupboard-core (Cupboard interface, Table interface, standard table names)
- prd-sqlite-backend (JSON format, SQLite schema, links table, graph model)
- prd-crumbs-interface (Crumb struct, crumb operations)

# PRD: Trails Interface

## Problem

Applications need to support exploratory work sessions where users can try different approaches without committing to them permanently. A developer might start working on a feature, explore multiple implementation paths, and later decide to keep some work while discarding dead ends. Without trails, all crumbs are permanent from the moment of creation, making exploratory workflows awkward or impossible.

We need a way to group crumbs into exploratory sessions (trails) that can later be committed (made permanent) or abandoned (discarded entirely). This enables backtracking and branching without cluttering the main work stream with abandoned attempts.

This PRD defines the TrailTable interface: the Trail struct, lifecycle operations (Start, Complete, Abandon), and crumb membership queries. Trail membership is stored via the links table (belongs_to relationship); this PRD specifies the semantics while prd-sqlite-backend specifies the storage.

## Goals

1. Define the Trail struct with all required fields
2. Define trail states and their meaning
3. Specify Start operation for creating new trails
4. Specify Get operation for retrieving trails
5. Specify GetCrumbs operation for listing crumbs on a trail
6. Specify Complete operation semantics (crumbs become permanent)
7. Specify Abandon operation semantics (crumbs are deleted)
8. Document error conditions for all operations

## Requirements

### R1: Trail Struct

1.1. The Trail struct must include these fields:

| Field | Type | Description |
|-------|------|-------------|
| TrailID | string | UUID v7, generated on creation |
| ParentCrumbID | *string | Optional crumb ID this trail deviates from; nil if standalone |
| State | string | Trail state (see R2) |
| CreatedAt | time.Time | Timestamp of creation |
| CompletedAt | *time.Time | Timestamp when completed or abandoned; nil if active |

1.2. TrailID must be a UUID v7 (time-ordered) generated by the backend on Start.

1.3. ParentCrumbID links the trail to an existing crumb, allowing branching from a specific point in the work graph. When set, the trail represents an alternative approach starting from that crumb.

1.4. CompletedAt is set when the trail transitions to completed or abandoned state.

### R2: State Values

2.1. A trail must be in exactly one of these states:

| State | Description |
|-------|-------------|
| active | Trail is open for work; crumbs can be added |
| completed | Trail is finished; crumbs have been made permanent |
| abandoned | Trail is discarded; crumbs have been deleted |

2.2. Initial state on Start is active.

2.3. State transitions are one-way: active can transition to completed or abandoned, but completed and abandoned are terminal states.

2.4. State is stored as a string, not an enum, for JSON compatibility.

### R3: Start Operation

3.1. Start creates a new trail:

```go
func (t TrailTable) Start(parentCrumbID *string) (*Trail, error)
```

3.2. Start must generate a UUID v7 for TrailID.

3.3. Start must set State to "active", CreatedAt to now, and CompletedAt to nil.

3.4. If parentCrumbID is provided, Start must validate that the crumb exists (ErrNotFound if not).

3.5. If parentCrumbID is provided, Start must store it on the Trail.

3.6. Start must persist the trail before returning.

3.7. Start must return the created Trail with all fields populated.

3.8. Start may be called with nil parentCrumbID to create a standalone trail not linked to any existing crumb.

### R4: Get Operation

4.1. Get retrieves a trail by ID:

```go
func (t TrailTable) Get(id string) (*Trail, error)
```

4.2. Get must return the Trail if found.

4.3. Get must return ErrNotFound if no trail exists with the given ID.

4.4. Get must return ErrInvalidID if id is empty.

### R5: GetCrumbs Operation

5.1. GetCrumbs lists all crumbs belonging to a trail:

```go
func (t TrailTable) GetCrumbs(id string) ([]*Crumb, error)
```

5.2. GetCrumbs queries the links table for belongs_to links where to_id equals the trail ID.

5.3. GetCrumbs must return an empty slice (not nil) if the trail has no crumbs.

5.4. GetCrumbs must return ErrNotFound if no trail exists with the given ID.

5.5. GetCrumbs must return ErrInvalidID if id is empty.

5.6. Results are ordered by crumb CreatedAt ascending (oldest first, preserving creation order).

5.7. GetCrumbs returns the full Crumb objects, not just IDs.

### R6: Complete Operation

6.1. Complete marks a trail as finished and makes its crumbs permanent:

```go
func (t TrailTable) Complete(id string) error
```

6.2. Complete must set the trail's State to "completed".

6.3. Complete must set CompletedAt to the current time.

6.4. Complete must remove all belongs_to links for crumbs on this trail. After completion, the crumbs exist but do not belong to any trail.

6.5. Complete must return ErrNotFound if no trail exists with the given ID.

6.6. Complete must return ErrInvalidID if id is empty.

6.7. Complete must return ErrInvalidState if the trail is not in "active" state.

6.8. Complete must be atomic: all changes succeed or none do.

6.9. After Complete, the crumbs are indistinguishable from crumbs that were never on a trail. They have become permanent parts of the work graph.

### R7: Abandon Operation

7.1. Abandon discards a trail and deletes all its crumbs:

```go
func (t TrailTable) Abandon(id string) error
```

7.2. Abandon must set the trail's State to "abandoned".

7.3. Abandon must set CompletedAt to the current time.

7.4. Abandon must delete all crumbs that belong to this trail (via belongs_to links).

7.5. For each deleted crumb, Abandon must also delete:

- All property values for the crumb (crumb_properties)
- All metadata for the crumb
- All links where the crumb is from_id or to_id (belongs_to, child_of)

7.6. Abandon must return ErrNotFound if no trail exists with the given ID.

7.7. Abandon must return ErrInvalidID if id is empty.

7.8. Abandon must return ErrInvalidState if the trail is not in "active" state.

7.9. Abandon must be atomic: all deletions succeed or none do.

7.10. After Abandon, the trail remains in the database (for audit purposes) but has no associated crumbs.

### R8: Crumb Membership

8.1. A crumb belongs to a trail via a belongs_to link in the links table:

| Field | Value |
|-------|-------|
| link_type | "belongs_to" |
| from_id | crumb_id |
| to_id | trail_id |

8.2. A crumb can belong to at most one trail at a time. The backend must enforce this constraint.

8.3. Crumbs not on any trail (no belongs_to link) are considered permanent or "untracked."

8.4. Adding a crumb to a trail is done via the LinkTable interface (Add with link_type "belongs_to"). This PRD does not define that operation; see prd-sqlite-backend for the LinkTable interface.

8.5. Moving a crumb between trails requires removing the old belongs_to link and adding a new one.

### R9: Error Types

9.1. TrailTable operations must return these sentinel errors:

| Error | When |
|-------|------|
| ErrNotFound | Trail or crumb ID does not exist |
| ErrInvalidID | Trail ID is empty |
| ErrInvalidState | Operation not valid for current trail state |
| ErrCupboardClosed | Cupboard has been closed |

9.2. All errors must be checkable with errors.Is.

9.3. ErrInvalidState should include the current state and expected state in the error message for debugging.

## Non-Goals

1. This PRD does not define crumb CRUD operations. See prd-crumbs-interface.

2. This PRD does not define the LinkTable interface or how to add crumbs to trails. The LinkTable (Add, Remove, GetByFrom, GetByTo) is defined in prd-cupboard-core and detailed in prd-sqlite-backend.

3. This PRD does not define nested trails or trail hierarchies. Each trail is independent.

4. This PRD does not define undo for Complete or Abandon. These are terminal operations.

5. This PRD does not define batch operations on trails (e.g., merge trails, split trails).

## Acceptance Criteria

- [ ] Trail struct defined with TrailID, ParentCrumbID, State, CreatedAt, CompletedAt
- [ ] State values documented (active, completed, abandoned)
- [ ] Start operation specified (create trail, optional parent crumb)
- [ ] Get operation specified (retrieve by ID, error handling)
- [ ] GetCrumbs operation specified (list crumbs via belongs_to links)
- [ ] Complete operation specified (mark completed, remove belongs_to links)
- [ ] Abandon operation specified (mark abandoned, delete crumbs and links)
- [ ] Crumb membership semantics documented (belongs_to link, one trail per crumb)
- [ ] Error types documented
- [ ] All requirements numbered and specific
- [ ] File saved at docs/product-requirements/prd-trails-interface.md

## Constraints

- TrailID uses UUID v7 for time-ordering and uniqueness
- State is a string for JSON serialization (not a Go enum)
- All timestamps use time.Time (RFC 3339 in JSON)
- Crumb membership is stored in the links table, not on the Trail struct
- Complete and Abandon are terminal; there is no way to revert

## References

- prd-cupboard-core (Cupboard interface, TrailTable accessor)
- prd-sqlite-backend (JSON format, SQLite schema, links table, graph model)
- prd-crumbs-interface (Crumb struct, crumb operations)

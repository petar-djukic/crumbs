# PRD: Crumbs Interface

## Problem

Applications need to create, retrieve, and manage individual work items (crumbs). prd-cupboard-core defines the Cupboard interface with a CrumbTable accessor, but it does not specify the Crumb data structure, operation semantics, or query capabilities. Without this specification, implementations will make inconsistent decisions about field names, state transitions, and property handling.

This PRD defines the CrumbTable interface: the Crumb struct, CRUD operations, query filtering, and property value operations. Trail membership is not stored on the Crumb; the links table (prd-sqlite-backend) handles belongs_to relationships.

## Goals

1. Define the Crumb struct with all required fields
2. Define state values and their meaning
3. Specify Add, Get, Archive, and Purge operations
4. Define filter maps and Fetch operation for querying crumbs
5. Specify property value operations (SetProperty, GetProperty, GetProperties, ClearProperty)
6. Document error conditions for all operations

## Requirements

### R1: Crumb Struct

1.1. The Crumb struct must include these fields:

| Field | Type | Description |
|-------|------|-------------|
| CrumbID | string | UUID v7, generated on creation |
| Name | string | Human-readable name (required, non-empty) |
| State | string | Crumb state (see R2) |
| CreatedAt | time.Time | Timestamp of creation |
| UpdatedAt | time.Time | Timestamp of last modification |

1.2. CrumbID must be a UUID v7 (time-ordered) generated by the backend on Add.

1.3. Name must be non-empty. Add must reject empty names with ErrInvalidName.

1.4. Trail membership is not a Crumb field. Use the links table (belongs_to link type) to associate crumbs with trails. See prd-sqlite-backend.

1.5. CreatedAt and UpdatedAt must be set to the current time on creation. UpdatedAt must be updated on any modification (state change, property change).

### R2: State Values

2.1. A crumb must be in exactly one of these states:

| State | Description |
|-------|-------------|
| draft | Being written or rewritten; not yet ready for consideration |
| pending | Created but not ready for work (e.g., waiting for dependencies) |
| ready | Available for assignment |
| taken | Currently being worked on |
| completed | Successfully finished |
| failed | Terminated with error |
| archived | Stored and inactive; moved to cold storage |

2.2. Initial state on Add is draft.

2.3. State transitions are not enforced by CrumbTable. Any state can transition to any other state. Higher-level logic (e.g., workflow rules) may enforce constraints.

2.4. State is stored as a string, not an enum, for JSON compatibility.

2.5. The states form a logical progression: draft → pending → ready → taken → (completed|failed) → archived. However, CrumbTable does not enforce this progression.

### R3: Add Operation

3.1. Add creates a new crumb:

```go
func (t CrumbTable) Add(name string) (*Crumb, error)
```

3.2. Add must generate a UUID v7 for CrumbID.

3.3. Add must set State to "draft", CreatedAt to now, and UpdatedAt to now.

3.4. Add must return ErrInvalidName if name is empty.

3.5. Add must persist the crumb before returning.

3.6. Add must return the created Crumb with all fields populated.

### R4: Get Operation

4.1. Get retrieves a crumb by ID:

```go
func (t CrumbTable) Get(id string) (*Crumb, error)
```

4.2. Get must return the Crumb if found.

4.3. Get must return ErrNotFound if no crumb exists with the given ID.

4.4. Get must return ErrInvalidID if id is empty.

### R5: Archive Operation

5.1. Archive transitions a crumb to the archived state (soft delete):

```go
func (t CrumbTable) Archive(id string) error
```

5.2. Archive must set the crumb's State to "archived".

5.3. Archive must update the crumb's UpdatedAt timestamp.

5.4. Archive must return ErrNotFound if no crumb exists with the given ID.

5.5. Archive must return ErrInvalidID if id is empty.

5.6. Archive is idempotent: archiving an already-archived crumb succeeds without error.

5.7. Archived crumbs remain queryable via Fetch. Applications filter by state to exclude archived crumbs from active views.

### R6: Purge Operation

6.1. Purge permanently removes a crumb and all associated data (hard delete):

```go
func (t CrumbTable) Purge(id string) error
```

6.2. Purge must remove the crumb record.

6.3. Purge must remove all property values for the crumb (crumb_properties).

6.4. Purge must remove all metadata for the crumb.

6.5. Purge must remove all links where the crumb is from_id or to_id (belongs_to, child_of).

6.6. Purge must return ErrNotFound if no crumb exists with the given ID.

6.7. Purge must return ErrInvalidID if id is empty.

6.8. Purge must be atomic: all deletions succeed or none do.

6.9. Purge is intended for cleanup of archived crumbs. Applications should typically Archive first, then Purge later during maintenance.

### R7: Filter Map

7.1. Filters are expressed as `map[string]any` where keys are filter names and values are filter criteria:

```go
type Filter = map[string]any
```

7.2. Supported filter keys:

| Key | Value Type | Description |
| --- | ---------- | ----------- |
| "states" | []string | Match any of these states (omit for all) |
| "trail_id" | string | Match crumbs in this trail (via belongs_to link) |
| "parent_id" | string | Match crumbs that are children of this crumb (via child_of link) |
| "properties" | map[string]any | Match crumbs with these property values |
| "limit" | int | Maximum results (omit or 0 for no limit) |
| "offset" | int | Skip this many results |

7.3. An empty or nil filter matches all crumbs.

7.4. Multiple filter keys are ANDed: a crumb must match all specified criteria.

7.5. Unknown filter keys must be ignored (forward compatibility).

7.6. Results are ordered by CreatedAt descending (newest first).

### R8: Fetch Operation

8.1. Fetch queries crumbs matching a filter:

```go
func (t CrumbTable) Fetch(filter map[string]any) ([]*Crumb, error)
```

8.2. Fetch must return all crumbs matching the filter criteria.

8.3. Fetch must return an empty slice (not nil) if no crumbs match.

8.4. Fetch must apply limit and offset after filtering and ordering.

8.5. Fetch must not return an error for an empty result set.

8.6. Fetch must return ErrInvalidFilter if a filter value has the wrong type (e.g., "states" is not []string).

### R9: SetProperty Operation

9.1. SetProperty assigns a value to a crumb property:

```go
func (t CrumbTable) SetProperty(crumbID, propertyID string, value any) error
```

9.2. SetProperty must validate that the crumb exists (ErrNotFound if not).

9.3. SetProperty must validate that the property exists (ErrPropertyNotFound if not).

9.4. SetProperty must validate that value matches the property's value_type:

| value_type | Go type | Example |
|------------|---------|---------|
| text | string | "description text" |
| integer | int64 | 42 |
| categorical | string | category_id |
| list | []string | ["tag1", "tag2"] |

9.5. For categorical properties, value must be a valid category_id for that property (ErrInvalidCategory if not).

9.6. SetProperty must create or update the crumb_properties record.

9.7. SetProperty must update the crumb's UpdatedAt timestamp.

### R10: GetProperty Operation

10.1. GetProperty retrieves a single property value:

```go
func (t CrumbTable) GetProperty(crumbID, propertyID string) (any, error)
```

10.2. GetProperty must return the value if set.

10.3. GetProperty must return ErrNotFound if the crumb does not exist.

10.4. GetProperty must return ErrPropertyNotFound if the property does not exist.

10.5. GetProperty must return ErrPropertyNotSet if the property exists but has no value for this crumb.

10.6. The returned value type corresponds to the property's value_type (see R9.4).

### R11: GetProperties Operation

11.1. GetProperties retrieves all property values for a crumb:

```go
func (t CrumbTable) GetProperties(crumbID string) (map[string]any, error)
```

11.2. GetProperties must return a map from property_id to value.

11.3. GetProperties must return an empty map (not nil) if no properties are set.

11.4. GetProperties must return ErrNotFound if the crumb does not exist.

### R12: ClearProperty Operation

12.1. ClearProperty removes a property value from a crumb:

```go
func (t CrumbTable) ClearProperty(crumbID, propertyID string) error
```

12.2. ClearProperty must delete the crumb_properties record.

12.3. ClearProperty must return ErrNotFound if the crumb does not exist.

12.4. ClearProperty must return ErrPropertyNotFound if the property does not exist.

12.5. ClearProperty must succeed (no error) if the property exists but was not set. This is idempotent.

12.6. ClearProperty must update the crumb's UpdatedAt timestamp.

### R13: Error Types

13.1. CrumbTable operations must return these sentinel errors:

| Error | When |
|-------|------|
| ErrNotFound | Crumb ID does not exist |
| ErrInvalidID | Crumb ID is empty |
| ErrInvalidName | Name is empty (on Add) |
| ErrInvalidFilter | Filter value has wrong type |
| ErrPropertyNotFound | Property ID does not exist |
| ErrPropertyNotSet | Property exists but has no value for crumb |
| ErrInvalidCategory | Category ID is not valid for the property |
| ErrTypeMismatch | Value type does not match property value_type |
| ErrCupboardClosed | Cupboard has been closed |

13.2. All errors must be checkable with errors.Is.

## Non-Goals

1. This PRD does not define trail operations. See prd-trails-interface.

2. This PRD does not define property definitions. See prd-properties-interface.

3. This PRD does not define state transition rules or workflow constraints. CrumbTable allows any state change.

4. This PRD does not define batch operations (e.g., bulk archive, bulk update).

5. This PRD does not define full-text search on crumb names or content.

## Acceptance Criteria

- [ ] Crumb struct defined with CrumbID, Name, State, CreatedAt, UpdatedAt
- [ ] State values documented (draft, pending, ready, taken, completed, failed, archived)
- [ ] Add operation specified (create crumb, generate UUID v7, set initial state to draft)
- [ ] Get operation specified (retrieve by ID, error handling)
- [ ] Archive operation specified (soft delete, transition to archived state)
- [ ] Purge operation specified (hard delete, remove crumb and all associated data)
- [ ] Filter map defined with states, trail_id, parent_id, properties, limit, offset
- [ ] Fetch operation specified (query with filter map, pagination)
- [ ] Property operations specified (SetProperty, GetProperty, GetProperties, ClearProperty)
- [ ] Error types documented
- [ ] All requirements numbered and specific
- [ ] File saved at docs/product-requirements/prd-crumbs-interface.md

## Constraints

- CrumbID uses UUID v7 for time-ordering and uniqueness
- Property values are stored as JSON-compatible types
- State is a string for JSON serialization (not a Go enum)
- All timestamps use time.Time (RFC 3339 in JSON)
- Filter uses map[string]any for flexibility; backends translate to queries

## References

- prd-cupboard-core (Cupboard interface, CrumbTable accessor)
- prd-sqlite-backend (JSON format, SQLite schema, links table)
- prd-trails-interface (trail operations, belongs_to relationship)
- prd-properties-interface (property definitions, value types)

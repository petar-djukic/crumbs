# PRD: Crumbs Interface

## Problem

Applications need to create, retrieve, and manage individual work items (crumbs). prd-cupboard-core defines the Cupboard interface with a CrumbTable accessor, but it does not specify the Crumb data structure, operation semantics, or query capabilities. Without this specification, implementations will make inconsistent decisions about field names, state transitions, and property handling.

This PRD defines the CrumbTable interface: the Crumb struct, CRUD operations, query filtering, and property value operations. Trail membership is not stored on the Crumb; the links table (prd-sqlite-backend) handles belongs_to relationships.

## Goals

1. Define the Crumb struct with all required fields
2. Define state values and their meaning
3. Specify Drop, Get, and Delete operations
4. Define the Filter struct and Fetch operation for querying crumbs
5. Specify property value operations (SetProperty, GetProperty, GetProperties, ClearProperty)
6. Document error conditions for all operations

## Requirements

### R1: Crumb Struct

1.1. The Crumb struct must include these fields:

| Field | Type | Description |
|-------|------|-------------|
| CrumbID | string | UUID v7, generated on creation |
| Name | string | Human-readable name (required, non-empty) |
| State | string | Crumb state (see R2) |
| CreatedAt | time.Time | Timestamp of creation |
| UpdatedAt | time.Time | Timestamp of last modification |

1.2. CrumbID must be a UUID v7 (time-ordered) generated by the backend on Drop.

1.3. Name must be non-empty. Drop must reject empty names with ErrInvalidName.

1.4. Trail membership is not a Crumb field. Use the links table (belongs_to link type) to associate crumbs with trails. See prd-sqlite-backend.

1.5. CreatedAt and UpdatedAt must be set to the current time on creation. UpdatedAt must be updated on any modification (state change, property change).

### R2: State Values

2.1. A crumb must be in exactly one of these states:

| State | Description |
|-------|-------------|
| pending | Created but not ready for work (e.g., waiting for dependencies) |
| ready | Available for assignment |
| running | Currently being worked on |
| completed | Successfully finished |
| failed | Terminated with error |

2.2. Initial state on Drop is pending.

2.3. State transitions are not enforced by CrumbTable. Any state can transition to any other state. Higher-level logic (e.g., workflow rules) may enforce constraints.

2.4. State is stored as a string, not an enum, for JSON compatibility.

### R3: Drop Operation

3.1. Drop creates a new crumb:

```go
func (t CrumbTable) Drop(name string) (*Crumb, error)
```

3.2. Drop must generate a UUID v7 for CrumbID.

3.3. Drop must set State to "pending", CreatedAt to now, and UpdatedAt to now.

3.4. Drop must return ErrInvalidName if name is empty.

3.5. Drop must persist the crumb before returning.

3.6. Drop must return the created Crumb with all fields populated.

### R4: Get Operation

4.1. Get retrieves a crumb by ID:

```go
func (t CrumbTable) Get(id string) (*Crumb, error)
```

4.2. Get must return the Crumb if found.

4.3. Get must return ErrNotFound if no crumb exists with the given ID.

4.4. Get must return ErrInvalidID if id is empty.

### R5: Delete Operation

5.1. Delete removes a crumb and all associated data:

```go
func (t CrumbTable) Delete(id string) error
```

5.2. Delete must remove the crumb record.

5.3. Delete must remove all property values for the crumb (crumb_properties).

5.4. Delete must remove all metadata for the crumb.

5.5. Delete must remove all links where the crumb is from_id or to_id (belongs_to, child_of).

5.6. Delete must return ErrNotFound if no crumb exists with the given ID.

5.7. Delete must return ErrInvalidID if id is empty.

5.8. Delete must be atomic: all deletions succeed or none do.

### R6: Filter Struct

6.1. The Filter struct specifies query criteria for Fetch:

```go
type Filter struct {
    States      []string          // Match any of these states (empty = all)
    TrailID     *string           // Match crumbs in this trail (via belongs_to link)
    ParentID    *string           // Match crumbs that are children of this crumb (via child_of link)
    Properties  map[string]any    // Match crumbs with these property values
    Limit       int               // Maximum results (0 = no limit)
    Offset      int               // Skip this many results
}
```

6.2. All filter fields are optional. An empty filter matches all crumbs.

6.3. Multiple criteria are ANDed: a crumb must match all non-empty criteria.

6.4. States filter: crumb.State must be in the States slice. Empty slice matches all states.

6.5. TrailID filter: crumb must have a belongs_to link to the specified trail.

6.6. ParentID filter: crumb must have a child_of link with the specified crumb as parent.

6.7. Properties filter: for each key-value pair, the crumb must have that property set to that value.

6.8. Limit and Offset support pagination. Results are ordered by CreatedAt descending (newest first).

### R7: Fetch Operation

7.1. Fetch queries crumbs matching a filter:

```go
func (t CrumbTable) Fetch(filter Filter) ([]*Crumb, error)
```

7.2. Fetch must return all crumbs matching the filter criteria.

7.3. Fetch must return an empty slice (not nil) if no crumbs match.

7.4. Fetch must apply Limit and Offset after filtering and ordering.

7.5. Fetch must not return an error for an empty result set.

### R8: SetProperty Operation

8.1. SetProperty assigns a value to a crumb property:

```go
func (t CrumbTable) SetProperty(crumbID, propertyID string, value any) error
```

8.2. SetProperty must validate that the crumb exists (ErrNotFound if not).

8.3. SetProperty must validate that the property exists (ErrPropertyNotFound if not).

8.4. SetProperty must validate that value matches the property's value_type:

| value_type | Go type | Example |
|------------|---------|---------|
| text | string | "description text" |
| integer | int64 | 42 |
| categorical | string | category_id |
| list | []string | ["tag1", "tag2"] |

8.5. For categorical properties, value must be a valid category_id for that property (ErrInvalidCategory if not).

8.6. SetProperty must create or update the crumb_properties record.

8.7. SetProperty must update the crumb's UpdatedAt timestamp.

### R9: GetProperty Operation

9.1. GetProperty retrieves a single property value:

```go
func (t CrumbTable) GetProperty(crumbID, propertyID string) (any, error)
```

9.2. GetProperty must return the value if set.

9.3. GetProperty must return ErrNotFound if the crumb does not exist.

9.4. GetProperty must return ErrPropertyNotFound if the property does not exist.

9.5. GetProperty must return ErrPropertyNotSet if the property exists but has no value for this crumb.

9.6. The returned value type corresponds to the property's value_type (see R8.4).

### R10: GetProperties Operation

10.1. GetProperties retrieves all property values for a crumb:

```go
func (t CrumbTable) GetProperties(crumbID string) (map[string]any, error)
```

10.2. GetProperties must return a map from property_id to value.

10.3. GetProperties must return an empty map (not nil) if no properties are set.

10.4. GetProperties must return ErrNotFound if the crumb does not exist.

### R11: ClearProperty Operation

11.1. ClearProperty removes a property value from a crumb:

```go
func (t CrumbTable) ClearProperty(crumbID, propertyID string) error
```

11.2. ClearProperty must delete the crumb_properties record.

11.3. ClearProperty must return ErrNotFound if the crumb does not exist.

11.4. ClearProperty must return ErrPropertyNotFound if the property does not exist.

11.5. ClearProperty must succeed (no error) if the property exists but was not set. This is idempotent.

11.6. ClearProperty must update the crumb's UpdatedAt timestamp.

### R12: Error Types

12.1. CrumbTable operations must return these sentinel errors:

| Error | When |
|-------|------|
| ErrNotFound | Crumb ID does not exist |
| ErrInvalidID | Crumb ID is empty |
| ErrInvalidName | Name is empty (on Drop) |
| ErrPropertyNotFound | Property ID does not exist |
| ErrPropertyNotSet | Property exists but has no value for crumb |
| ErrInvalidCategory | Category ID is not valid for the property |
| ErrTypeMismatch | Value type does not match property value_type |
| ErrCupboardClosed | Cupboard has been closed |

12.2. All errors must be checkable with errors.Is.

## Non-Goals

1. This PRD does not define trail operations. See prd-trails-interface.

2. This PRD does not define property definitions. See prd-properties-interface.

3. This PRD does not define state transition rules or workflow constraints. CrumbTable allows any state change.

4. This PRD does not define batch operations (e.g., bulk delete, bulk update).

5. This PRD does not define full-text search on crumb names or content.

## Acceptance Criteria

- [ ] Crumb struct defined with CrumbID, Name, State, CreatedAt, UpdatedAt
- [ ] State values documented (pending, ready, running, completed, failed)
- [ ] Drop operation specified (create crumb, generate UUID v7, set initial state)
- [ ] Get operation specified (retrieve by ID, error handling)
- [ ] Delete operation specified (remove crumb and associated data)
- [ ] Filter struct defined with States, TrailID, ParentID, Properties, Limit, Offset
- [ ] Fetch operation specified (query with filter, pagination)
- [ ] Property operations specified (SetProperty, GetProperty, GetProperties, ClearProperty)
- [ ] Error types documented
- [ ] All requirements numbered and specific
- [ ] File saved at docs/product-requirements/prd-crumbs-interface.md

## Constraints

- CrumbID uses UUID v7 for time-ordering and uniqueness
- Property values are stored as JSON-compatible types
- State is a string for JSON serialization (not a Go enum)
- All timestamps use time.Time (RFC 3339 in JSON)

## References

- prd-cupboard-core (Cupboard interface, CrumbTable accessor)
- prd-sqlite-backend (JSON format, SQLite schema, links table)
- prd-trails-interface (trail operations, belongs_to relationship)
- prd-properties-interface (property definitions, value types)

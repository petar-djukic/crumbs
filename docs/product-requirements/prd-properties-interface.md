# PRD: Properties Interface

## Problem

Applications need extensible attributes on crumbs beyond the core fields (name, state, timestamps). A task tracker might need priority, labels, and owner; a bug tracker might need severity and component. Hardcoding these fields into the Crumb struct creates rigid schemas that require code changes and migrations for every new attribute.

We need a property system where applications can define custom attributes at runtime. Properties are metadata definitions (name, type, description) that can then be assigned values on individual crumbs. This separates schema (what properties exist) from data (what values crumbs have), enabling flexibility without migrations.

This PRD defines the Property and Category entities: their struct fields and entity methods. Properties and categories are stored and retrieved via the generic Table interface from prd-cupboard-core. Setting and getting property values on crumbs is handled by Crumb entity methods (see prd-crumbs-interface); this PRD covers only the property definitions themselves.

## Goals

1. Define the Property struct with all required fields
2. Define the Category struct for categorical properties
3. Define value types and their meaning
4. Specify entity method DefineCategory for creating categories on a property
5. Specify how properties are created, retrieved, and queried via the Table interface
6. Document built-in properties seeded on first startup
7. Document error conditions for all operations

## Requirements

### R1: Property Struct

1.1. The Property struct must include these fields:

| Field | Type | Description |
|-------|------|-------------|
| PropertyID | string | UUID v7, generated on creation |
| Name | string | Unique human-readable name (e.g., "priority", "labels") |
| Description | string | Optional explanation of the property's purpose |
| ValueType | string | Type of values this property accepts (see R3) |
| CreatedAt | time.Time | Timestamp of creation |

1.2. PropertyID must be a UUID v7 (time-ordered) generated by the backend when Table.Set is called with an empty id parameter.

1.3. Name must be unique across all properties. Table.Set must reject duplicate names with ErrDuplicateName.

1.4. Name must be non-empty. Table.Set must reject empty names with ErrInvalidName.

1.5. Description may be empty.

### R2: Category Struct

2.1. The Category struct must include these fields:

| Field | Type | Description |
|-------|------|-------------|
| CategoryID | string | UUID v7, generated on creation |
| PropertyID | string | The categorical property this category belongs to |
| Name | string | Display name for this category (e.g., "high", "medium") |
| Ordinal | int | Sort order; lower ordinals sort first |

2.2. CategoryID must be a UUID v7 (time-ordered) generated by the backend when Table.Set is called with an empty id parameter.

2.3. Categories enable ordered enumeration for categorical properties. When a crumb has a categorical property value, the value is a CategoryID.

2.4. Name must be unique within a property. Table.Set must reject duplicate names for the same property with ErrDuplicateName.

2.5. Ordinal determines display order. Categories with lower ordinals appear first. Multiple categories may share the same ordinal (ties broken by name).

### R3: Value Types

3.1. A property must have exactly one of these value types:

| ValueType | Go Type | JSON Type | Description |
|-----------|---------|-----------|-------------|
| categorical | string | string | CategoryID from the property's categories |
| text | string | string | Free-form text |
| integer | int64 | number | Whole number |
| boolean | bool | boolean | True or false |
| timestamp | time.Time | string | RFC 3339 timestamp |
| list | []string | array | List of strings (e.g., labels, tags) |

3.2. ValueType is stored as a string, not an enum, for JSON compatibility.

3.3. Crumb.SetProperty validates that values match the property's ValueType (see prd-crumbs-interface R5).

3.4. For categorical properties, values must be valid CategoryIDs defined for that property.

3.5. Each value type has a default value used when initializing properties on crumbs:

| ValueType | Default Value | Description |
|-----------|---------------|-------------|
| categorical | null | No category selected; first category by ordinal if categories exist |
| text | "" | Empty string |
| integer | 0 | Zero |
| boolean | false | False |
| timestamp | null | No timestamp set |
| list | [] | Empty list |

3.6. Default values ensure every crumb has a value for every defined property. There is no concept of a property being "not set" on a crumb.

### R4: Creating Properties

4.1. To create a new property, the caller constructs a Property struct and passes it to Table.Set:

```go
prop := &Property{
    Name:        "priority",
    Description: "Task priority level",
    ValueType:   "categorical",
}
id, err := table.Set("", prop)
```

4.2. When Table.Set is called with an empty id parameter, the backend must:

- Generate a UUID v7 for PropertyID
- Set CreatedAt to the current time
- Validate that Name is non-empty (ErrInvalidName if empty)
- Validate that Name is unique (ErrDuplicateName if exists)
- Validate that ValueType is one of the valid types in R3.1 (ErrInvalidValueType if not)
- Initialize the property on all existing crumbs with the type's default value (see R3.5)

4.3. Property initialization on existing crumbs (backfill) is atomic with property creation: if backfill fails, the property is not created.

4.4. Table.Set returns the generated PropertyID and any error. After successful creation, the Property struct is updated with the generated PropertyID and CreatedAt timestamp.

4.5. Table.Set must persist the property before returning.

### R5: Retrieving Properties

5.1. To retrieve a property by ID, use Table.Get:

```go
entity, err := table.Get(id)
if err != nil {
    // handle error
}
prop := entity.(*Property)
```

5.2. Table.Get returns the entity as any; the caller must type-assert to *Property.

5.3. Table.Get returns ErrNotFound if no property exists with the given ID.

5.4. Table.Get returns ErrInvalidID if id is empty.

### R6: Querying Properties

6.1. To retrieve all properties, use Table.Fetch with an empty filter:

```go
entities, err := table.Fetch(nil)
props := make([]*Property, len(entities))
for i, entity := range entities {
    props[i] = entity.(*Property)
}
```

6.2. Table.Fetch returns a slice of entities ([]any); the caller must type-assert each element to *Property.

6.3. Table.Fetch returns an empty slice (not nil) if no properties exist.

6.4. Results are ordered by CreatedAt ascending (oldest first, built-ins first).

### R7: DefineCategory Entity Method

7.1. DefineCategory is an entity method on Property that creates a new category:

```go
func (p *Property) DefineCategory(cupboard Cupboard, name string, ordinal int) (*Category, error)
```

7.2. DefineCategory must validate that the property's ValueType is "categorical" (ErrInvalidValueType if not).

7.3. DefineCategory must validate that name is non-empty (ErrInvalidName if empty).

7.4. DefineCategory must validate that name is unique within the property (ErrDuplicateName if exists).

7.5. DefineCategory must create a Category struct with:

- A UUID v7 for CategoryID (generated by the backend)
- PropertyID set to the property's ID
- The provided name and ordinal

7.6. DefineCategory must persist the category to backend storage. The backend manages category storage internally (e.g., SQLite backend uses categories.jsonl).

7.7. DefineCategory must return the created Category with all fields populated.

7.8. Ordinal may be any integer. Negative ordinals are allowed.

7.9. DefineCategory requires the Cupboard reference to access backend storage for categories.

### R8: GetCategories Entity Method

8.1. GetCategories is an entity method on Property that retrieves all categories for the property:

```go
func (p *Property) GetCategories(cupboard Cupboard) ([]*Category, error)
```

8.2. GetCategories must validate that the property's ValueType is "categorical" (ErrInvalidValueType if not).

8.3. GetCategories must query backend storage for categories with a filter for PropertyID.

8.4. GetCategories must return categories ordered by ordinal ascending, then name ascending for ties.

8.5. GetCategories must return an empty slice (not nil) if no categories are defined for the property.

8.6. GetCategories requires the Cupboard reference to access backend storage for categories.

### R9: Built-in Properties

9.1. On first startup (when properties storage is empty), the backend must seed these built-in properties:

| Name | ValueType | Description |
|------|-----------|-------------|
| priority | categorical | Task priority level |
| type | categorical | Crumb type classification |
| description | text | Detailed description |
| owner | text | Assigned worker or user ID |
| labels | list | Capability tags or labels |

Note: Crumb dependencies use `child_of` links (see prd-sqlite-backend), not a property.

9.2. Built-in categories for "priority" property:

| Name | Ordinal |
|------|---------|
| highest | 0 |
| high | 1 |
| medium | 2 |
| low | 3 |
| lowest | 4 |

9.3. Built-in categories for "type" property:

| Name | Ordinal |
|------|---------|
| task | 0 |
| epic | 1 |
| bug | 2 |
| chore | 3 |

9.4. Seeding only occurs when the properties storage is empty (first run). Existing data is never modified by seeding.

9.5. Built-in properties can be extended (new categories added) but not deleted or renamed.

9.6. Applications may define additional properties beyond the built-ins.

### R10: Error Types

10.1. Property and Category operations must return these sentinel errors:

| Error | When |
|-------|------|
| ErrNotFound | Property or category ID does not exist |
| ErrInvalidID | ID is empty |
| ErrInvalidName | Name is empty |
| ErrDuplicateName | Name already exists (property or category within property) |
| ErrInvalidValueType | ValueType is not recognized or operation invalid for type |
| ErrCupboardDetached | Cupboard has been detached |

10.2. All errors must be checkable with errors.Is.

## Non-Goals

1. This PRD does not define setting or getting property values on crumbs. See prd-crumbs-interface for SetProperty, GetProperty, GetProperties, and ClearProperty.

2. This PRD does not define property deletion. Properties are permanent once defined. Applications can stop using a property but cannot remove its definition.

3. This PRD does not define property modification (renaming, changing type). Properties are immutable after creation.

4. This PRD does not define property inheritance or computed properties.

5. This PRD does not define validation rules beyond type checking (e.g., regex patterns, min/max values).

6. This PRD does not define a specialized PropertyTable interface. Properties and categories are accessed via the standard Table interface from prd-cupboard-core.

## Acceptance Criteria

- [ ] Property struct defined with PropertyID, Name, Description, ValueType, CreatedAt
- [ ] Category struct defined with CategoryID, PropertyID, Name, Ordinal
- [ ] Value types documented (categorical, text, integer, boolean, timestamp, list)
- [ ] Default values documented for each value type (R3.5)
- [ ] Property creation via Table.Set specified (ID generation, validation, backfill existing crumbs)
- [ ] Property retrieval via Table.Get specified (type assertion to *Property)
- [ ] Property query via Table.Fetch specified (list all properties)
- [ ] DefineCategory entity method specified (create category, validation, persist via Table.Set)
- [ ] GetCategories entity method specified (retrieve categories for a property)
- [ ] Built-in properties listed (priority, type, description, owner, labels)
- [ ] Built-in categories listed for priority and type
- [ ] Error types documented
- [ ] All requirements numbered and specific
- [ ] File saved at docs/product-requirements/prd-properties-interface.md

## Constraints

- PropertyID and CategoryID use UUID v7 for time-ordering and uniqueness
- ValueType is a string for JSON serialization (not a Go enum)
- All timestamps use time.Time (RFC 3339 in JSON)
- Property names must be unique across the entire cupboard
- Category names must be unique within their property
- Properties and categories are immutable after creation

## References

- prd-cupboard-core (Cupboard interface, Table interface, standard table names)
- prd-sqlite-backend (JSON format, SQLite schema, built-in property seeding)
- prd-crumbs-interface (SetProperty, GetProperty, GetProperties, ClearProperty)
